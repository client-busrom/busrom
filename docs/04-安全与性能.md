# 04 å®‰å…¨ä¸æ€§èƒ½

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æŠ€æœ¯æ ˆ**: Keystone 6 + Redis + AWS
**æœ€åæ›´æ–°**: 2025-11-04

---

## æ–‡æ¡£å¯¼èˆª

- [01-æ•°æ®æ¨¡å‹ä¸æ¶æ„](./01-æ•°æ®æ¨¡å‹ä¸æ¶æ„.md)
- [02-APIæ¥å£è§„èŒƒ](./02-APIæ¥å£è§„èŒƒ.md)
- [03-CMSåå°åŠŸèƒ½](./03-CMSåå°åŠŸèƒ½.md)
- **å½“å‰æ–‡æ¡£**: 04-å®‰å…¨ä¸æ€§èƒ½
- [05-éƒ¨ç½²ä¸éªŒæ”¶](./05-éƒ¨ç½²ä¸éªŒæ”¶.md)

---

## ğŸ” å®‰å…¨ä¸æ€§èƒ½å®ç°

### 1. è¡¨å•å®‰å…¨æªæ–½

**é›†æˆreCAPTCHA v3**:

```typescript
// lib/recaptcha.ts
export async function verifyRecaptcha(token: string): Promise<boolean> {
  const config = await getSiteConfig();

  if (!config.enableCaptcha) {
    return true; // éªŒè¯ç æœªå¯ç”¨,ç›´æ¥é€šè¿‡
  }

  const response = await fetch(
    'https://www.google.com/recaptcha/api/siteverify',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        secret: config.recaptchaSecretKey,
        response: token,
      })
    }
  );

  const data = await response.json();

  return data.success && data.score >= 0.5; // åˆ†æ•°é˜ˆå€¼
}

// åœ¨è¡¨å•æäº¤æ—¶è°ƒç”¨
export const ContactForm = list({
  hooks: {
    validateInput: async ({ resolvedData, addValidationError, context }) => {
      const recaptchaToken = context.req.headers['x-recaptcha-token'];

      if (!recaptchaToken) {
        addValidationError('ç¼ºå°‘éªŒè¯ç ');
        return;
      }

      const isValid = await verifyRecaptcha(recaptchaToken);

      if (!isValid) {
        addValidationError('éªŒè¯ç éªŒè¯å¤±è´¥');
      }
    }
  }
});
```

**è¯·æ±‚é¢‘ç‡é™åˆ¶**:
```typescript
// lib/rate-limiter.ts
import { RateLimiterMemory } from 'rate-limiter-flexible';

const rateLimiter = new RateLimiterMemory({
  points: 3, // 3æ¬¡è¯·æ±‚
  duration: 60, // æ¯60ç§’
});

export async function checkRateLimit(ip: string): Promise<boolean> {
  try {
    await rateLimiter.consume(ip);
    return true;
  } catch {
    return false;
  }
}

// åœ¨Keystoneä¸­é—´ä»¶ä¸­åº”ç”¨
export default config({
  server: {
    extendExpressApp: (app, createContext) => {
      app.use('/api/contact', async (req, res, next) => {
        const allowed = await checkRateLimit(req.ip);

        if (!allowed) {
          return res.status(429).json({
            error: 'è¯·æ±‚è¿‡äºé¢‘ç¹,è¯·ç¨åå†è¯•'
          });
        }

        next();
      });
    }
  }
});
```

---

### 2. ç¼“å­˜ç­–ç•¥

**Redisç¼“å­˜é›†æˆ**:

```typescript
// lib/cache.ts
import Redis from 'ioredis';

const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: parseInt(process.env.REDIS_PORT),
  password: process.env.REDIS_PASSWORD,
});

export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 3600
): Promise<T> {
  // å°è¯•ä»ç¼“å­˜è·å–
  const cached = await redis.get(key);

  if (cached) {
    return JSON.parse(cached);
  }

  // ç¼“å­˜æœªå‘½ä¸­,è·å–æ•°æ®
  const data = await fetcher();

  // å†™å…¥ç¼“å­˜
  await redis.setex(key, ttl, JSON.stringify(data));

  return data;
}

export async function clearCache(pattern: string) {
  const keys = await redis.keys(pattern);
  if (keys.length > 0) {
    await redis.del(...keys);
  }
}
```

**åº”ç”¨åˆ°APIæŸ¥è¯¢**:
```typescript
// app/api/home/route.ts
export async function GET() {
  const homeData = await getCached(
    'home-data',
    async () => {
      return await fetch('/api/graphql', {
        method: 'POST',
        body: JSON.stringify({
          query: GET_HOME_DATA_QUERY
        })
      }).then(r => r.json());
    },
    3600 // ç¼“å­˜1å°æ—¶
  );

  return Response.json(homeData);
}
```

**è‡ªåŠ¨æ¸…é™¤ç¼“å­˜**:
```typescript
// Keystone Hook
export const Product = list({
  hooks: {
    afterOperation: async ({ operation }) => {
      if (['create', 'update', 'delete'].includes(operation)) {
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        await clearCache('home-data');
        await clearCache('product-*');
      }
    }
  }
});
```

---

### 3. æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥**:
```typescript
export const Product = list({
  fields: {
    sku: text({
      validation: { isRequired: true },
      isIndexed: 'unique', // å”¯ä¸€ç´¢å¼•
    }),

    name: text({
      isIndexed: true, // æ™®é€šç´¢å¼•(ç”¨äºæœç´¢)
    }),

    series: relationship({
      ref: 'ProductSeries.products',
      // è‡ªåŠ¨åœ¨å¤–é”®ä¸Šåˆ›å»ºç´¢å¼•
    }),

    createdAt: timestamp({
      defaultValue: { kind: 'now' },
      db: {
        isIndexed: true, // æ—¶é—´å­—æ®µç´¢å¼•(ç”¨äºæ’åº)
      }
    }),
  },

  // æ•°æ®åº“å±‚é¢çš„çº¦æŸ
  db: {
    indexes: [
      {
        name: 'product_series_category_idx',
        fields: ['seriesId', 'categoryId'], // å¤åˆç´¢å¼•
      },
      {
        name: 'product_featured_idx',
        fields: ['featured', 'order'], // ç²¾é€‰äº§å“æŸ¥è¯¢ä¼˜åŒ–
      }
    ]
  }
});
```

**é¿å…N+1æŸ¥è¯¢**:
```typescript
// ä½¿ç”¨GraphQL DataLoader
import DataLoader from 'dataloader';

const productSeriesLoader = new DataLoader(async (ids: string[]) => {
  const series = await context.query.ProductSeries.findMany({
    where: { id: { in: ids } }
  });

  return ids.map(id => series.find(s => s.id === id));
});

// åœ¨resolverä¸­ä½¿ç”¨
const products = await context.query.Product.findMany({
  where: { featured: true }
});

// æ‰¹é‡åŠ è½½å…³è”çš„ç³»åˆ—
const seriesIds = products.map(p => p.seriesId);
const series = await productSeriesLoader.loadMany(seriesIds);
```

---

### 4. å›¾ç‰‡ä¼˜åŒ–å’ŒCDN

**MinIOæœ¬åœ°å¼€å‘é…ç½®**:
```yaml
# docker-compose.yml
version: '3.8'

services:
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - minio

volumes:
  minio_data:
```

**Nginxåä»£é…ç½®**:
```nginx
# nginx.conf
http {
  upstream minio_cdn {
    server minio:9000;
  }

  # ç¼“å­˜é…ç½®
  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cdn_cache:10m max_size=1g inactive=7d;

  server {
    listen 80;
    server_name localhost;

    location / {
      proxy_pass http://minio_cdn;
      proxy_set_header Host $host;

      # ç¼“å­˜æ§åˆ¶
      proxy_cache cdn_cache;
      proxy_cache_valid 200 7d;
      proxy_cache_valid 404 1h;

      # æ·»åŠ ç¼“å­˜çŠ¶æ€å¤´
      add_header X-Cache-Status $upstream_cache_status;

      # å›¾ç‰‡å‹ç¼©
      gzip on;
      gzip_types image/jpeg image/png image/webp;
      gzip_comp_level 6;

      # ç¼“å­˜å¤´
      expires 7d;
      add_header Cache-Control "public, immutable";
    }
  }
}
```

**ç”Ÿäº§ç¯å¢ƒAWS S3 + CloudFront**:
```typescript
// keystone.ts (ç”Ÿäº§é…ç½®)
export default config({
  storage: {
    s3_images: {
      kind: 's3',
      type: 'image',
      bucketName: process.env.S3_BUCKET_NAME,
      region: process.env.S3_REGION,
      accessKeyId: process.env.S3_ACCESS_KEY_ID,
      secretAccessKey: process.env.S3_SECRET_ACCESS_KEY,

      // CloudFront CDN URL
      generateUrl: (filename) =>
        `https://cdn.busrom.com/${filename}`,

      // ä¸Šä¼ æ—¶çš„å…ƒæ•°æ®
      s3Options: {
        CacheControl: 'max-age=31536000, public, immutable',
        ContentType: 'image/jpeg',
      }
    }
  }
});
```

---

## ğŸ“ å¼€å‘æ¸…å•å’Œé‡Œç¨‹ç¢‘

### Week 1-2: åŸºç¡€æ¶æ„ âœ…

- [ ] Keystone 6é¡¹ç›®åˆå§‹åŒ–
- [ ] PostgreSQLæ•°æ®åº“é…ç½®
- [ ] S3/MinIOå­˜å‚¨é›†æˆ
- [ ] å®Œå–„å·²æœ‰æ•°æ®æ¨¡å‹(Product, ProductSeries, Blogç­‰)
- [ ] æ–°å¢æ•°æ®æ¨¡å‹(ContactForm, CustomScript, SeoSetting, SiteConfigç­‰)
- [ ] åŸºç¡€APIæµ‹è¯•

### Week 3-4: CMSæ ¸å¿ƒåŠŸèƒ½ ğŸ”²

- [ ] å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é…ç½®
- [ ] å¤šå›¾ä¸Šä¼ å’Œåª’ä½“ç®¡ç†
- [ ] å›¾ç‰‡ä¼˜åŒ–pipeline(å¤šå°ºå¯¸ã€WebP)
- [ ] å¯¼èˆªèœå•ç®¡ç†ç•Œé¢
- [ ] é¦–é¡µå†…å®¹é…ç½®ç³»ç»Ÿ
- [ ] SEOè®¾ç½®ç•Œé¢

### Week 5: è¡¨å•å’Œé‚®ä»¶ç³»ç»Ÿ ğŸ”²

- [ ] è¡¨å•æäº¤æ¥å£
- [ ] é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ(SMTPé›†æˆ)
- [ ] reCAPTCHAé›†æˆ
- [ ] è¯·æ±‚é¢‘ç‡é™åˆ¶
- [ ] åå°è¡¨å•ç®¡ç†ç•Œé¢
- [ ] CSVå¯¼å‡ºåŠŸèƒ½

### Week 6: é«˜çº§åŠŸèƒ½ ğŸ”²

- [ ] è‡ªå®šä¹‰ä»£ç ç®¡ç†
- [ ] è„šæœ¬å®‰å…¨éªŒè¯
- [ ] ä»£ç é¢„è§ˆåŠŸèƒ½
- [ ] æ“ä½œæ—¥å¿—ç³»ç»Ÿ
- [ ] æƒé™ç®¡ç†å®Œå–„
- [ ] åŒå› ç´ è®¤è¯(å¯é€‰)

### Week 7: SEOè‡ªåŠ¨åŒ– ğŸ”²

- [ ] Sitemapè‡ªåŠ¨ç”Ÿæˆ
- [ ] Robots.txtåŠ¨æ€é…ç½®
- [ ] Google Indexing APIé›†æˆ
- [ ] IndexNowåè®®å®ç°
- [ ] ç»“æ„åŒ–æ•°æ®ç”Ÿæˆ
- [ ] Open Graphæ ‡ç­¾æ”¯æŒ

### Week 8: æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯• ğŸ”²

- [ ] Redisç¼“å­˜å±‚éƒ¨ç½²
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] APIå“åº”å‹ç¼©
- [ ] CDNé…ç½®(CloudFront)
- [ ] è´Ÿè½½æµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡

### Week 9-10: éƒ¨ç½²å’Œç›‘æ§ ğŸ”²

- [ ] AWS EC2ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] CloudWatchç›‘æ§é…ç½®
- [ ] æ—¥å¿—æ”¶é›†ç³»ç»Ÿ
- [ ] è‡ªåŠ¨å¤‡ä»½ç­–ç•¥
- [ ] CI/CDæµç¨‹è®¾ç½®
- [ ] æ–‡æ¡£å®Œå–„

---

## ä¸‹ä¸€æ­¥

å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–å®Œæˆ,æœ€åäº†è§£éƒ¨ç½²å’ŒéªŒæ”¶æ ‡å‡†:
- [05-éƒ¨ç½²ä¸éªŒæ”¶](./05-éƒ¨ç½²ä¸éªŒæ”¶.md) - å­¦ä¹ å¦‚ä½•éƒ¨ç½²ç³»ç»Ÿå¹¶éªŒæ”¶

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ
**æœ€åå®¡æ ¸**: 2025-11-04
