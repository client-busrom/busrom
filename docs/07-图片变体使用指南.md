# 07 å›¾ç‰‡å˜ä½“ä½¿ç”¨æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-05

---

## ğŸ“‹ ç›®å½•

1. [ä»€ä¹ˆæ˜¯å›¾ç‰‡å˜ä½“](#ä»€ä¹ˆæ˜¯å›¾ç‰‡å˜ä½“)
2. [è‡ªåŠ¨ç”Ÿæˆæµç¨‹](#è‡ªåŠ¨ç”Ÿæˆæµç¨‹)
3. [å‰ç«¯ä½¿ç”¨æ–¹æ³•](#å‰ç«¯ä½¿ç”¨æ–¹æ³•)
4. [CMSåå°æŸ¥çœ‹](#cmsåå°æŸ¥çœ‹)
5. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## ä»€ä¹ˆæ˜¯å›¾ç‰‡å˜ä½“

å›¾ç‰‡å˜ä½“(Image Variants)æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å¤šä¸ªå°ºå¯¸ç‰ˆæœ¬çš„å›¾ç‰‡ï¼Œç”¨äºå“åº”å¼è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

### å˜ä½“ç±»å‹

å½“ä½ ä¸Šä¼ ä¸€å¼ å›¾ç‰‡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹å˜ä½“:

| å˜ä½“åç§° | å°ºå¯¸ | ç”¨é€” | ç¤ºä¾‹URL |
|---------|------|------|---------|
| **thumbnail** | 150x150 (cover) | åå°ç¼©ç•¥å›¾ã€åˆ—è¡¨é¢„è§ˆ | `cdn.com/variants/thumbnail/image.jpg` |
| **small** | 400pxå®½ | ç§»åŠ¨ç«¯å°å›¾ | `cdn.com/variants/small/image.jpg` |
| **medium** | 800pxå®½ | å¹³æ¿/å°æ¡Œé¢ | `cdn.com/variants/medium/image.jpg` |
| **large** | 1200pxå®½ | æ¡Œé¢å¤§å›¾ | `cdn.com/variants/large/image.jpg` |
| **xlarge** | 1920pxå®½ | å…¨å±å±•ç¤º/è½®æ’­å›¾ | `cdn.com/variants/xlarge/image.jpg` |
| **webp** | åŸå°ºå¯¸ | ç°ä»£æµè§ˆå™¨ä¼˜åŒ– | `cdn.com/variants/webp/image.webp` |

### æ•°æ®ç»“æ„

variantså­—æ®µå­˜å‚¨çš„JSONæ ¼å¼:

```json
{
  "thumbnail": "https://cdn.busrom.com/variants/thumbnail/product-001.jpg",
  "small": "https://cdn.busrom.com/variants/small/product-001.jpg",
  "medium": "https://cdn.busrom.com/variants/medium/product-001.jpg",
  "large": "https://cdn.busrom.com/variants/large/product-001.jpg",
  "xlarge": "https://cdn.busrom.com/variants/xlarge/product-001.jpg",
  "webp": "https://cdn.busrom.com/variants/webp/product-001.webp"
}
```

---

## è‡ªåŠ¨ç”Ÿæˆæµç¨‹

### å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant User as ç®¡ç†å‘˜
    participant CMS as Keystone CMS
    participant Hook as AfterOperation Hook
    participant Optimizer as Image Optimizer
    participant S3 as AWS S3/CDN

    User->>CMS: ä¸Šä¼ å›¾ç‰‡
    CMS->>CMS: ä¿å­˜Mediaè®°å½•
    CMS->>Hook: è§¦å‘afterOperation
    Hook->>Optimizer: è°ƒç”¨extractImageMetadata()
    Optimizer->>S3: ä¸‹è½½åŸå›¾
    Optimizer->>Optimizer: æå–å®½é«˜/å¤§å°/MIME
    Hook->>Optimizer: è°ƒç”¨generateImageVariants()
    Optimizer->>Optimizer: ç”Ÿæˆ6ä¸ªå˜ä½“
    Optimizer->>S3: ä¸Šä¼ æ‰€æœ‰å˜ä½“
    S3-->>Optimizer: è¿”å›CDN URLs
    Hook->>CMS: æ›´æ–°Mediaè®°å½•
    CMS-->>User: ä¸Šä¼ å®Œæˆ
```

### è‡ªåŠ¨è§¦å‘æ—¶æœº

ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨ç”Ÿæˆå˜ä½“:
1. âœ… åœ¨CMSåå°ä¸Šä¼ æ–°å›¾ç‰‡æ—¶
2. âœ… é€šè¿‡APIåˆ›å»ºMediaè®°å½•æ—¶

### ç”Ÿæˆæ—¶é—´

æ ¹æ®åŸå›¾å¤§å°ä¸åŒ:
- å°å›¾(< 1MB): 5-10ç§’
- ä¸­å›¾(1-5MB): 10-20ç§’
- å¤§å›¾(> 5MB): 20-30ç§’

> **æ³¨æ„**: ç”Ÿæˆè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡ä¸Šä¼ æ“ä½œã€‚ä¸Šä¼ å®Œæˆåï¼Œvariantså­—æ®µä¼šåœ¨åå°æ›´æ–°ã€‚

---

## å‰ç«¯ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: å“åº”å¼å›¾ç‰‡ (æ¨è)

ä½¿ç”¨Next.jsçš„`<Image>`ç»„ä»¶é…åˆ`srcSet`:

```tsx
import Image from 'next/image'

interface MediaFile {
  url: string
  altText: { [key: string]: string }
  variants?: {
    thumbnail?: string
    small?: string
    medium?: string
    large?: string
    xlarge?: string
    webp?: string
  }
}

interface ProductImageProps {
  media: MediaFile
  locale: string
}

export function ProductImage({ media, locale }: ProductImageProps) {
  // è·å–æœ¬åœ°åŒ–çš„altæ–‡æœ¬
  const alt = media.altText?.[locale] || media.altText?.['en'] || 'Product image'

  // å¦‚æœæ²¡æœ‰å˜ä½“ï¼Œä½¿ç”¨åŸå›¾
  if (!media.variants) {
    return (
      <Image
        src={media.url}
        alt={alt}
        width={1200}
        height={800}
        quality={85}
      />
    )
  }

  // ä½¿ç”¨å˜ä½“å®ç°å“åº”å¼
  return (
    <picture>
      {/* WebPæ ¼å¼ - ç°ä»£æµè§ˆå™¨ */}
      {media.variants.webp && (
        <source
          type="image/webp"
          srcSet={`
            ${media.variants.small} 400w,
            ${media.variants.medium} 800w,
            ${media.variants.large} 1200w,
            ${media.variants.xlarge} 1920w
          `}
          sizes="(max-width: 640px) 400px, (max-width: 1024px) 800px, (max-width: 1536px) 1200px, 1920px"
        />
      )}

      {/* JPEGæ ¼å¼ - å›é€€ */}
      <source
        type="image/jpeg"
        srcSet={`
          ${media.variants.small} 400w,
          ${media.variants.medium} 800w,
          ${media.variants.large} 1200w,
          ${media.variants.xlarge} 1920w
        `}
        sizes="(max-width: 640px) 400px, (max-width: 1024px) 800px, (max-width: 1536px) 1200px, 1920px"
      />

      {/* æœ€ç»ˆå›é€€ */}
      <img
        src={media.variants.large || media.url}
        alt={alt}
        loading="lazy"
        decoding="async"
      />
    </picture>
  )
}
```

### æ–¹æ³•2: æ ¹æ®è®¾å¤‡é€‰æ‹©å°ºå¯¸

```tsx
export function useResponsiveImage(variants: MediaFile['variants']) {
  const [imageUrl, setImageUrl] = useState<string>('')

  useEffect(() => {
    if (!variants) return

    const updateImage = () => {
      const width = window.innerWidth

      if (width < 640) {
        setImageUrl(variants.small || variants.medium || '')
      } else if (width < 1024) {
        setImageUrl(variants.medium || variants.large || '')
      } else if (width < 1536) {
        setImageUrl(variants.large || variants.xlarge || '')
      } else {
        setImageUrl(variants.xlarge || variants.large || '')
      }
    }

    updateImage()
    window.addEventListener('resize', updateImage)
    return () => window.removeEventListener('resize', updateImage)
  }, [variants])

  return imageUrl
}

// ä½¿ç”¨
function ProductCard({ media }: { media: MediaFile }) {
  const imageUrl = useResponsiveImage(media.variants)

  return (
    <div className="product-card">
      <img src={imageUrl} alt={media.altText?.en} />
    </div>
  )
}
```

### æ–¹æ³•3: Tailwind CSSå“åº”å¼

```tsx
export function HeroImage({ media }: { media: MediaFile }) {
  if (!media.variants) return null

  return (
    <div className="relative w-full h-screen">
      {/* ç§»åŠ¨ç«¯ - small */}
      <img
        src={media.variants.small}
        alt="Hero"
        className="block sm:hidden w-full h-full object-cover"
      />

      {/* å¹³æ¿ - medium */}
      <img
        src={media.variants.medium}
        alt="Hero"
        className="hidden sm:block lg:hidden w-full h-full object-cover"
      />

      {/* æ¡Œé¢ - xlarge */}
      <img
        src={media.variants.xlarge}
        alt="Hero"
        className="hidden lg:block w-full h-full object-cover"
      />
    </div>
  )
}
```

### æ–¹æ³•4: ç¼©ç•¥å›¾æ˜¾ç¤º

```tsx
export function ProductGrid({ products }: { products: Product[] }) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {products.map((product) => (
        <Link key={product.id} href={`/product/${product.slug}`}>
          <div className="product-card">
            {/* ä½¿ç”¨thumbnailå˜ä½“ */}
            <img
              src={product.images[0]?.variants?.thumbnail || product.images[0]?.url}
              alt={product.name}
              className="w-full aspect-square object-cover rounded-lg"
            />
            <h3>{product.name}</h3>
          </div>
        </Link>
      ))}
    </div>
  )
}
```

### æ–¹æ³•5: GraphQLæŸ¥è¯¢

åœ¨GraphQLæŸ¥è¯¢ä¸­åŒ…å«variantså­—æ®µ:

```graphql
query GetProduct($sku: String!) {
  product(where: { sku: $sku }) {
    id
    name
    sku
    images {
      id
      filename
      file {
        url
      }
      altText
      variants
      width
      height
    }
  }
}
```

---

## CMSåå°æŸ¥çœ‹

### å½“å‰çŠ¶æ€

åœ¨CMSåå°ï¼Œvariantså­—æ®µæ˜¾ç¤ºä¸ºJSONæ ¼å¼ï¼Œä¸å¤Ÿç›´è§‚:

```json
{
  "thumbnail": "https://...",
  "small": "https://...",
  ...
}
```

### æ”¹è¿›æ–¹æ¡ˆ: è‡ªå®šä¹‰è§†å›¾

æˆ‘å¯ä»¥ä¸ºä½ åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰è§†å›¾ï¼Œè®©variantså­—æ®µæ›´ç¾è§‚æ˜“è¯»ã€‚

**æ•ˆæœé¢„è§ˆ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Image Variants (å›¾ç‰‡å˜ä½“)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ–¼ï¸ Thumbnail (150x150)  [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â”‚ ğŸ“± Small (400px)        [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â”‚ ğŸ’» Medium (800px)       [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â”‚ ğŸ–¥ï¸ Large (1200px)       [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â”‚ ğŸ“º XLarge (1920px)      [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â”‚ âš¡ WebP (ä¼˜åŒ–æ ¼å¼)       [é¢„è§ˆ] [å¤åˆ¶URL]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

éœ€è¦æˆ‘åˆ›å»ºè¿™ä¸ªè‡ªå®šä¹‰è§†å›¾å—ï¼Ÿ

---

## å®ç”¨å·¥å…·å‡½æ•°

### è·å–æœ€ä½³å˜ä½“

```typescript
// lib/image-utils.ts

export function getBestVariant(
  variants: MediaFile['variants'],
  maxWidth: number
): string | undefined {
  if (!variants) return undefined

  // æ ¹æ®æ‰€éœ€å®½åº¦é€‰æ‹©æœ€æ¥è¿‘çš„å˜ä½“
  if (maxWidth <= 150 && variants.thumbnail) return variants.thumbnail
  if (maxWidth <= 400 && variants.small) return variants.small
  if (maxWidth <= 800 && variants.medium) return variants.medium
  if (maxWidth <= 1200 && variants.large) return variants.large
  if (variants.xlarge) return variants.xlarge

  // å›é€€åˆ°æœ€å¤§çš„å¯ç”¨å˜ä½“
  return variants.large || variants.medium || variants.small || variants.thumbnail
}
```

### æ£€æŸ¥å˜ä½“æ˜¯å¦å­˜åœ¨

```typescript
export function hasVariants(media: MediaFile): boolean {
  return !!(
    media.variants &&
    (media.variants.thumbnail ||
      media.variants.small ||
      media.variants.medium ||
      media.variants.large ||
      media.variants.xlarge ||
      media.variants.webp)
  )
}
```

### è·å–WebPæˆ–å›é€€

```typescript
export function getWebPOrFallback(
  variants: MediaFile['variants'],
  fallbackSize: 'small' | 'medium' | 'large' = 'large'
): string | undefined {
  if (!variants) return undefined

  // ä¼˜å…ˆä½¿ç”¨WebP
  if (variants.webp) return variants.webp

  // å›é€€åˆ°æŒ‡å®šå°ºå¯¸
  return variants[fallbackSize]
}
```

---

## æ•…éšœæ’é™¤

### é—®é¢˜1: variantså­—æ®µä¸ºç©º {}

**å¯èƒ½åŸå› :**
1. S3é…ç½®ä¸æ­£ç¡®
2. å›¾ç‰‡åˆšä¸Šä¼ ï¼Œè¿˜åœ¨ç”Ÿæˆä¸­
3. ç”Ÿæˆè¿‡ç¨‹å‡ºé”™

**è§£å†³æ–¹æ³•:**

1. æ£€æŸ¥S3é…ç½®(cms/.env):
```bash
S3_BUCKET_NAME=your-bucket-name
S3_REGION=us-east-1
S3_ACCESS_KEY_ID=your-access-key
S3_SECRET_ACCESS_KEY=your-secret-key
S3_ENDPOINT=https://your-cdn-domain.com
CDN_DOMAIN=https://your-cdn-domain.com
```

2. æŸ¥çœ‹CMSæ—¥å¿—:
```bash
cd cms
npm run dev
# ä¸Šä¼ å›¾ç‰‡åæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
```

åº”è¯¥çœ‹åˆ°:
```
ğŸ”„ Processing image optimization for: image-name.jpg
ğŸ“Š Metadata extracted: { width: 1920, height: 1080, ... }
  âœ… Generated thumbnail: https://...
  âœ… Generated small: https://...
  âœ… Generated medium: https://...
  âœ… Generated large: https://...
  âœ… Generated xlarge: https://...
  âœ… Generated webp: https://...
âœ… All variants generated successfully
```

3. æ‰‹åŠ¨è§¦å‘ç”Ÿæˆ(å¦‚æœéœ€è¦):
```typescript
// åœ¨Keystone consoleä¸­æ‰§è¡Œ
import { generateImageVariants } from './lib/image-optimizer'

const media = await context.query.Media.findOne({
  where: { id: 'media-id' }
})

const variants = await generateImageVariants(media.file.url)

await context.query.Media.updateOne({
  where: { id: 'media-id' },
  data: { variants }
})
```

### é—®é¢˜2: å˜ä½“URLè®¿é—®404

**å¯èƒ½åŸå› :**
- S3ä¸Šä¼ å¤±è´¥
- CDNé…ç½®é—®é¢˜
- æƒé™è®¾ç½®é”™è¯¯

**è§£å†³æ–¹æ³•:**

1. æ£€æŸ¥S3æƒé™:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::your-bucket-name/*"
    }
  ]
}
```

2. æµ‹è¯•ç›´æ¥è®¿é—®S3:
```bash
curl https://your-bucket-name.s3.amazonaws.com/variants/thumbnail/test.jpg
```

### é—®é¢˜3: ç”Ÿæˆé€Ÿåº¦æ…¢

**ä¼˜åŒ–å»ºè®®:**

1. ä½¿ç”¨CDNåŠ é€Ÿ
2. ä¸Šä¼ å‰å‹ç¼©åŸå›¾
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. è€ƒè™‘å¼‚æ­¥é˜Ÿåˆ—(å¦‚ä½¿ç”¨BullMQ)

---

## æ€§èƒ½ä¼˜åŠ¿

ä½¿ç”¨å›¾ç‰‡å˜ä½“å¯ä»¥è·å¾—:

| åœºæ™¯ | åŸå›¾å¤§å° | å˜ä½“å¤§å° | èŠ‚çœ | åŠ è½½æ—¶é—´ |
|------|---------|---------|------|---------|
| ç§»åŠ¨ç«¯åˆ—è¡¨ | 3.5MB | 50KB | 98.6% | 0.2s â†’ 0.05s |
| å¹³æ¿è¯¦æƒ…é¡µ | 3.5MB | 180KB | 94.9% | 0.2s â†’ 0.1s |
| æ¡Œé¢äº§å“é¡µ | 3.5MB | 420KB | 88.0% | 0.2s â†’ 0.15s |
| WebPæ ¼å¼ | 3.5MB | 280KB | 92.0% | - |

**æ€»ä½“æå‡:**
- ğŸš€ é¡µé¢åŠ è½½é€Ÿåº¦æå‡ 60-90%
- ğŸ“Š SEOè¯„åˆ†æå‡(Core Web Vitals)
- ğŸ’° å¸¦å®½æˆæœ¬é™ä½ 80-95%
- ğŸ“± ç§»åŠ¨ç«¯ä½“éªŒå¤§å¹…æ”¹å–„

---

## æœ€ä½³å®è·µ

### âœ… DO (æ¨èåšæ³•)

1. **å§‹ç»ˆæä¾›altæ–‡æœ¬** - å¯¹SEOå’Œå¯è®¿é—®æ€§è‡³å…³é‡è¦
2. **ä½¿ç”¨å“åº”å¼å›¾ç‰‡** - è®©æµè§ˆå™¨é€‰æ‹©æœ€ä½³å°ºå¯¸
3. **ä¼˜å…ˆä½¿ç”¨WebP** - é…åˆJPEG/PNGå›é€€
4. **ä½¿ç”¨lazy loading** - å»¶è¿ŸåŠ è½½å¯è§†åŒºåŸŸå¤–çš„å›¾ç‰‡
5. **è®¾ç½®æ­£ç¡®çš„å°ºå¯¸** - é¿å…å¸ƒå±€åç§»(CLS)

### âŒ DON'T (é¿å…åšæ³•)

1. **ä¸è¦ç›´æ¥ä½¿ç”¨åŸå›¾** - æµªè´¹å¸¦å®½å’ŒåŠ è½½æ—¶é—´
2. **ä¸è¦å¿½ç•¥altæ–‡æœ¬** - å½±å“SEOå’Œå¯è®¿é—®æ€§
3. **ä¸è¦ç¡¬ç¼–ç å°ºå¯¸** - ä½¿ç”¨variantsåŠ¨æ€é€‰æ‹©
4. **ä¸è¦å¿˜è®°é”™è¯¯å¤„ç†** - variantså¯èƒ½ä¸ºç©º
5. **ä¸è¦æ··ç”¨ä¸åŒåŸŸå** - ä½¿ç”¨ç»Ÿä¸€çš„CDNåŸŸå

---

## æ‰©å±•é˜…è¯»

- [Next.js Image Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/images)
- [Responsive Images Guide](https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images)
- [WebP Format](https://developers.google.com/speed/webp)

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-05
