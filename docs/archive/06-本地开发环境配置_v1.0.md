# 06 - æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®

> **é˜…è¯»æ—¶é—´**: 10 åˆ†é’Ÿ
> **é€‚ç”¨å¯¹è±¡**: å…¨ä½“å¼€å‘äººå‘˜

---

## ğŸ¯ æ¦‚è¿°

æœ¬åœ°å¼€å‘ç¯å¢ƒä½¿ç”¨ **MinIO + Nginx** æ›¿ä»£ AWS S3 + CloudFrontï¼Œå®ç°ï¼š

âœ… **é›¶ AWS è´¹ç”¨** - MinIO å®Œå…¨å…è´¹ï¼Œæœ¬åœ°è¿è¡Œ
âœ… **å®Œå…¨å…¼å®¹** - MinIO å®ç°äº† AWS S3 APIï¼Œä»£ç é›¶ä¿®æ”¹
âœ… **CDN æ¨¡æ‹Ÿ** - Nginx æä¾›ç¼“å­˜å±‚ï¼Œæ¨¡æ‹Ÿ CloudFront è¡Œä¸º
âœ… **å¿«é€Ÿå¼€å‘** - æœ¬åœ°å­˜å‚¨ï¼Œä¸Šä¼ ä¸‹è½½é€Ÿåº¦å¿«

---

## ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Local Development                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚              â”‚       â”‚              â”‚               â”‚
â”‚  â”‚  Keystone    â”œâ”€â”€â”€â”€â”€â”€â–ºâ”‚    MinIO     â”‚               â”‚
â”‚  â”‚  CMS         â”‚  S3   â”‚  (Port 9000) â”‚               â”‚
â”‚  â”‚  (Port 3000) â”‚  API  â”‚              â”‚               â”‚
â”‚  â”‚              â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                        â”‚
â”‚                                 â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                        â”‚
â”‚  â”‚              â”‚              â”‚                        â”‚
â”‚  â”‚  Next.js     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚  â”‚  Frontend    â”‚       Proxy via                       â”‚
â”‚  â”‚  (Port 3001) â”‚       Nginx CDN                       â”‚
â”‚  â”‚              â”‚       (Port 8080)                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚  PostgreSQL  â”‚                                       â”‚
â”‚  â”‚  (Port 5432) â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Production Environment:
  - MinIO â†’ AWS S3
  - Nginx CDN â†’ CloudFront
  - No code changes required!
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 2. æœåŠ¡è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | å‡­æ® |
|------|------|------|
| **PostgreSQL** | `localhost:5432` | `busrom / busrom_dev_password` |
| **MinIO Console** | http://localhost:9001 | `minioadmin / minioadmin123` |
| **MinIO API** | http://localhost:9000 | åŒä¸Š |
| **Nginx CDN** | http://localhost:8080 | - |
| **Keystone CMS** | http://localhost:3000 | (åˆ›å»ºç”¨æˆ·åç™»å½•) |

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# åœ¨ cms/ ç›®å½•ä¸‹
cd cms
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œç¡®ä¿ä»¥ä¸‹é…ç½®ï¼š
USE_MINIO=true
S3_ACCESS_KEY_ID=minioadmin
S3_SECRET_ACCESS_KEY=minioadmin123
S3_ENDPOINT=http://localhost:9000
S3_BUCKET_NAME=busrom-media
CDN_DOMAIN=http://localhost:8080
```

### 4. å¯åŠ¨ Keystone CMS

```bash
cd cms
npm install
npm run dev
```

### 5. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 

1. è®¿é—® http://localhost:3000
2. ç™»å½• Keystone Admin
3. è¿›å…¥ Media ç®¡ç†é¡µé¢
4. ä¸Šä¼ ä¸€å¼ æµ‹è¯•å›¾ç‰‡
5. å›¾ç‰‡ä¼šè‡ªåŠ¨å­˜å‚¨åˆ° MinIO
6. å¯ä»¥é€šè¿‡ä»¥ä¸‹ URL è®¿é—®ï¼š
   - ç›´æ¥è®¿é—®: `http://localhost:9000/busrom-media/æ–‡ä»¶å.jpg`
   - CDN è®¿é—®: `http://localhost:8080/busrom-media/æ–‡ä»¶å.jpg`

---

## ğŸ“¦ Docker æœåŠ¡è¯´æ˜

### PostgreSQL

- **é•œåƒ**: `postgres:15-alpine`
- **ç«¯å£**: `5432`
- **æ•°æ®å·**: `postgres_data`
- **ç”¨é€”**: Keystone CMS ä¸»æ•°æ®åº“

### MinIO (S3 æ›¿ä»£)

- **é•œåƒ**: `minio/minio:latest`
- **ç«¯å£**:
  - `9000` - S3 API ç«¯ç‚¹
  - `9001` - Web ç®¡ç†æ§åˆ¶å°
- **æ•°æ®å·**: `minio_data`
- **ç”¨é€”**: æœ¬åœ°å¯¹è±¡å­˜å‚¨ï¼Œæ›¿ä»£ AWS S3
- **ç‰¹æ€§**:
  - å®Œå…¨å…¼å®¹ AWS S3 API
  - è‡ªåŠ¨åˆ›å»º `busrom-media` bucket
  - æ”¯æŒå…¬å¼€è¯»å–ï¼ˆdevelopment onlyï¼‰

#### MinIO æ§åˆ¶å°ä½¿ç”¨

è®¿é—® http://localhost:9001ï¼Œå¯ä»¥ï¼š
- æµè§ˆæ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶
- æ‰‹åŠ¨ä¸Šä¼ /ä¸‹è½½æ–‡ä»¶
- ç®¡ç† bucket æƒé™
- æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨æƒ…å†µ

### MinIO Init (åˆå§‹åŒ–å®¹å™¨)

- **é•œåƒ**: `minio/mc:latest`
- **è¿è¡Œæ¨¡å¼**: ä¸€æ¬¡æ€§æ‰§è¡Œ
- **ç”¨é€”**: è‡ªåŠ¨åˆ›å»º bucket å¹¶è®¾ç½®æƒé™
- **æ“ä½œ**:
  ```bash
  # åˆ›å»º bucket
  mc mb local/busrom-media

  # è®¾ç½®å…¬å¼€è¯»å–æƒé™ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
  mc anonymous set download local/busrom-media
  ```

### Nginx CDN (CloudFront æ›¿ä»£)

- **é•œåƒ**: `nginx:alpine`
- **ç«¯å£**: `8080`
- **é…ç½®**: `docker/nginx/cdn.conf`
- **æ•°æ®å·**: `nginx_cache` (60MB ç¼“å­˜ç©ºé—´)
- **ç”¨é€”**: æä¾›ç¼“å­˜å±‚ï¼Œæ¨¡æ‹Ÿ CloudFront CDN
- **ç‰¹æ€§**:
  - ä»£ç† MinIO è¯·æ±‚
  - ç¼“å­˜å›¾ç‰‡æ–‡ä»¶ï¼ˆ60 åˆ†é’Ÿï¼‰
  - æ·»åŠ ç¼“å­˜å¤´ `X-Cache-Status`
  - CORS æ”¯æŒ

#### ç¼“å­˜éªŒè¯

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰
curl -I http://localhost:8080/busrom-media/test.jpg
# X-Cache-Status: MISS

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
curl -I http://localhost:8080/busrom-media/test.jpg
# X-Cache-Status: HIT
```

---

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### Docker Compose ç®¡ç†

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# é‡å¯æŸä¸ªæœåŠ¡
docker-compose restart minio

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f minio
docker-compose logs -f nginx-cdn

# æ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆå±é™©ï¼ï¼‰
docker-compose down -v
```

### MinIO CLI æ“ä½œ

```bash
# è¿›å…¥ MinIO å®¹å™¨
docker exec -it busrom-minio sh

# ä½¿ç”¨ mc å‘½ä»¤ç®¡ç†
mc alias set local http://localhost:9000 minioadmin minioadmin123
mc ls local/busrom-media/
mc cp /path/to/file.jpg local/busrom-media/
```

### æ¸…ç† Nginx ç¼“å­˜

```bash
# æ¸…ç©ºç¼“å­˜å·
docker-compose exec nginx-cdn rm -rf /var/cache/nginx/*

# æˆ–é‡å¯ Nginx
docker-compose restart nginx-cdn
```

---

## ğŸŒ ç¯å¢ƒåˆ‡æ¢

### æœ¬åœ°å¼€å‘ â†’ ç”Ÿäº§ç¯å¢ƒ

åªéœ€ä¿®æ”¹ `.env` æ–‡ä»¶ï¼š

```bash
# åˆ‡æ¢åˆ° AWS S3
USE_MINIO=false
S3_ACCESS_KEY_ID=your_aws_access_key
S3_SECRET_ACCESS_KEY=your_aws_secret_key
S3_ENDPOINT=  # ç•™ç©ºä½¿ç”¨ AWS S3
S3_BUCKET_NAME=busrom-media-production
CDN_DOMAIN=https://d1234567890.cloudfront.net
```

**æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼**

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. MinIO å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :9000
lsof -i :9001

# æ€æ­»å ç”¨è¿›ç¨‹æˆ–ä¿®æ”¹ docker-compose.yml ç«¯å£
```

### 2. å›¾ç‰‡ä¸Šä¼ å¤±è´¥

```bash
# æ£€æŸ¥ MinIO å¥åº·çŠ¶æ€
curl http://localhost:9000/minio/health/live

# æŸ¥çœ‹ Keystone æ—¥å¿—
cd cms && npm run dev

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat cms/.env | grep S3
```

### 3. CDN ç¼“å­˜æœªç”Ÿæ•ˆ

```bash
# æŸ¥çœ‹ Nginx æ—¥å¿—
docker-compose logs nginx-cdn

# æ£€æŸ¥ç¼“å­˜ç›®å½•æƒé™
docker-compose exec nginx-cdn ls -la /var/cache/nginx/

# æ‰‹åŠ¨æµ‹è¯•ç¼“å­˜
curl -I http://localhost:8080/busrom-media/test.jpg
```

### 4. Bucket ä¸å­˜åœ¨

```bash
# æ‰‹åŠ¨è¿è¡Œåˆå§‹åŒ–
docker-compose run --rm minio-init

# æˆ–é€šè¿‡ MinIO æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»º
# http://localhost:9001 â†’ Buckets â†’ Create Bucket
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | AWS S3 + CloudFront | MinIO + Nginx |
|------|---------------------|---------------|
| **ä¸Šä¼ é€Ÿåº¦** | å–å†³äºç½‘ç»œ (~10 MB/s) | æœ¬åœ°ç£ç›˜é€Ÿåº¦ (~100 MB/s) |
| **ä¸‹è½½é€Ÿåº¦** | å–å†³äº CDN (~50 MB/s) | æœ¬åœ°ç½‘ç»œ (~1 GB/s) |
| **å»¶è¿Ÿ** | 50-200ms | <5ms |
| **è´¹ç”¨** | æŒ‰ä½¿ç”¨é‡æ”¶è´¹ | **å®Œå…¨å…è´¹** |
| **ç¦»çº¿å¼€å‘** | âŒ éœ€è¦ç½‘ç»œ | âœ… æ”¯æŒ |

---

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### âš ï¸ ä»…é™å¼€å‘ç¯å¢ƒä½¿ç”¨

ä»¥ä¸‹é…ç½®**ä»…é€‚ç”¨äºæœ¬åœ°å¼€å‘**ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ï¼š

- MinIO ä½¿ç”¨é»˜è®¤å‡­æ® `minioadmin / minioadmin123`
- Bucket è®¾ç½®ä¸ºå…¬å¼€è¯»å–
- Nginx å…è®¸æ‰€æœ‰ CORS è¯·æ±‚
- æ•°æ®æœªåŠ å¯†

### ç”Ÿäº§ç¯å¢ƒè¦æ±‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»ï¼š
- ä½¿ç”¨å¼ºå¯†ç å’Œ IAM è§’è‰²
- å¯ç”¨ S3 bucket åŠ å¯†
- é…ç½® CloudFront ç­¾å URL
- é™åˆ¶ CORS æ¥æº
- å¯ç”¨è®¿é—®æ—¥å¿—

---

## ğŸ“š ç›¸å…³èµ„æº

- [MinIO å®˜æ–¹æ–‡æ¡£](https://min.io/docs/minio/linux/index.html)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Nginx ç¼“å­˜é…ç½®](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache)
- [Keystone S3 Storage](https://keystonejs.com/docs/apis/storage)

---

## ğŸ¤– Claude Code Prompt æ¨¡æ¿

```markdown
æˆ‘éœ€è¦ä½ å¸®æˆ‘è°ƒè¯• Busrom é¡¹ç›®çš„æœ¬åœ°å¼€å‘ç¯å¢ƒã€‚

**ç¯å¢ƒä¿¡æ¯**ï¼š
- MinIO: http://localhost:9000
- Nginx CDN: http://localhost:8080
- é—®é¢˜æè¿°: [æè¿°ä½ çš„é—®é¢˜]

**ä½ çš„ä»»åŠ¡**ï¼š
1. æ£€æŸ¥ docker-compose.yml é…ç½®
2. éªŒè¯ .env æ–‡ä»¶ä¸­çš„ S3 é…ç½®
3. æµ‹è¯• MinIO è¿æ¥
4. æ£€æŸ¥ Keystone storage é…ç½®
5. æä¾›è§£å†³æ–¹æ¡ˆ

è¯·å¼€å§‹è¯Šæ–­ã€‚
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-01
