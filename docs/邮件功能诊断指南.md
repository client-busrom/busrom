# é‚®ä»¶åŠŸèƒ½è¯Šæ–­æŒ‡å—

## é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆ: "æˆ‘å·²ç»å¡«äº† SMTP é…ç½®,ä½†å®¢æˆ·å¡«å†™è¡¨å•åæˆ‘æ²¡æœ‰æ”¶åˆ°é‚®ä»¶"

## å·²å®Œæˆçš„ä¿®å¤

### 1. âœ… ä¿®å¤äº† nodemailer API è°ƒç”¨é”™è¯¯

**é—®é¢˜**: `email-sender.ts:80` ä½¿ç”¨äº†é”™è¯¯çš„æ–¹æ³•å
```typescript
// é”™è¯¯ âŒ
nodemailer.createTransporter({...})

// æ­£ç¡® âœ…
nodemailer.createTransport({...})
```

**ä¿®å¤ä½ç½®**: `cms/lib/email-sender.ts:80`

### 2. âœ… å®ç°äº†é‚®ä»¶é˜Ÿåˆ—ç³»ç»Ÿ

**æ–°å¢æ–‡ä»¶**: `cms/lib/email-queue.ts`
**é›†æˆä½ç½®**: `cms/schemas/ContactForm.ts:258`

**ä¼˜åŠ¿**:
- éé˜»å¡å¼å‘é€
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ (3æ¬¡,é—´éš” 5s/10s/20s)
- å‘é€æ—¥å¿—è®°å½•

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1: æ£€æŸ¥ SMTP é…ç½®

åœ¨ CMS ç®¡ç†åå° â†’ Site Config ä¸­æ£€æŸ¥:

```
âœ“ smtpHost        (ä¾‹å¦‚: smtp.gmail.com)
âœ“ smtpPort        (ä¾‹å¦‚: 587 æˆ– 465)
âœ“ smtpUser        (SMTP ç”¨æˆ·å)
âœ“ smtpPassword    (SMTP å¯†ç )
âœ“ emailFromAddress (å‘ä»¶äººé‚®ç®±)
âœ“ formNotificationEmails (æ¥æ”¶é€šçŸ¥çš„é‚®ç®±,å¤šä¸ªç”¨é€—å·åˆ†éš”)
```

**é€šè¿‡ API æ£€æŸ¥é…ç½®**:
```bash
curl -X POST http://localhost:3000/api/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "query { siteConfig { smtpHost smtpPort smtpUser emailFromAddress formNotificationEmails } }"}'
```

### æ­¥éª¤ 2: æ£€æŸ¥ Keystone æœåŠ¡å™¨æ—¥å¿—

æäº¤è¡¨å•å,æœåŠ¡å™¨æ—¥å¿—åº”è¯¥æ˜¾ç¤º:

**âœ… æ­£å¸¸æ—¥å¿—**:
```
ğŸ“§ Sending email notification for contact form: Test User
ğŸ“¬ Email job added to queue: email-xxx (Queue size: 1)
ğŸ“§ Processing email job: email-xxx (Attempt 1/3)
âœ… Admin notification sent successfully to: your@email.com
âœ… Email job completed: email-xxx
âœ… Email notification queued (Job ID: email-xxx) for: Test User
```

**âŒ é”™è¯¯æ—¥å¿—**:
```
âš ï¸  SMTP configuration incomplete. Email sending disabled.
âŒ Error sending contact form notification: ...
âŒ Email job failed after 3 attempts
```

### æ­¥éª¤ 3: å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1: Gmail SMTP éœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç 

å¦‚æœä½¿ç”¨ Gmail (smtp.gmail.com):

1. âŒ **ä¸èƒ½ä½¿ç”¨**æ™®é€š Gmail å¯†ç 
2. âœ… **å¿…é¡»ä½¿ç”¨** [åº”ç”¨ä¸“ç”¨å¯†ç ](https://support.google.com/accounts/answer/185833)

**é…ç½®æ­¥éª¤**:
1. ç™»å½• Google è´¦æˆ· â†’ å®‰å…¨æ€§
2. å¼€å¯ä¸¤æ­¥éªŒè¯
3. ç”Ÿæˆ"åº”ç”¨ä¸“ç”¨å¯†ç "
4. åœ¨ CMS Site Config ä¸­ä½¿ç”¨è¯¥å¯†ç 

#### é—®é¢˜ 2: ç«¯å£é…ç½®é”™è¯¯

| ç«¯å£ | åŠ å¯†æ–¹å¼ | æ¨è |
|------|----------|------|
| 587  | STARTTLS | âœ… æ¨è |
| 465  | SSL/TLS  | âœ… æ¨è |
| 25   | æ— åŠ å¯†   | âŒ ä¸æ¨è |

#### é—®é¢˜ 3: é˜²ç«å¢™é˜»æ­¢

ç¡®ä¿æœåŠ¡å™¨å¯ä»¥è®¿é—® SMTP ç«¯å£:
```bash
# æµ‹è¯•è¿æ¥
nc -zv smtp.gmail.com 587
```

#### é—®é¢˜ 4: é‚®ç®±åœ°å€é”™è¯¯

æ£€æŸ¥ `formNotificationEmails` æ ¼å¼:
```
âœ… æ­£ç¡®: your@email.com
âœ… æ­£ç¡®: email1@test.com,email2@test.com
âŒ é”™è¯¯: your@email.com, (æœ‰ç©ºæ ¼)
âŒ é”™è¯¯: invalid-email
```

### æ­¥éª¤ 4: æŸ¥çœ‹é‚®ä»¶å‘é€æ ‡è®°

æŸ¥è¯¢æœ€è¿‘çš„è¡¨å•æäº¤:
```bash
curl -X POST http://localhost:3000/api/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "query { contactFormSubmissions(orderBy: { submittedAt: desc }, take: 5) { id name email emailSent submittedAt } }"}'
```

- `emailSent: true` - é‚®ä»¶å·²åŠ å…¥é˜Ÿåˆ—
- `emailSent: false` - é‚®ä»¶æœªå‘é€(å¯èƒ½é…ç½®æœ‰é—®é¢˜)

### æ­¥éª¤ 5: æµ‹è¯•é‚®ä»¶å‘é€

è¿è¡Œæµ‹è¯•è„šæœ¬:
```bash
cd cms
bash scripts/test-contact-form.sh
```

ç„¶åæŸ¥çœ‹ Keystone æœåŠ¡å™¨æ§åˆ¶å°æ—¥å¿—ã€‚

## æ‰‹åŠ¨æµ‹è¯•é‚®ä»¶é…ç½®

### æ–¹æ³• 1: ä½¿ç”¨ Keystone çš„æµ‹è¯•å‡½æ•°

åœ¨ `cms/lib/email-sender.ts` ä¸­å·²ç»æä¾›äº† `testEmailConfiguration` å‡½æ•°ã€‚

å¯ä»¥åœ¨ Keystone çš„ `onConnect` hook ä¸­è°ƒç”¨:
```typescript
// keystone.ts
async onConnect(context) {
  const { testEmailConfiguration } = require('./lib/email-sender')
  await testEmailConfiguration(context)
}
```

### æ–¹æ³• 2: é€šè¿‡ API æäº¤æµ‹è¯•è¡¨å•

```bash
curl -X POST http://localhost:3000/api/graphql \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation { createContactForm(data: { name: \"Test\", email: \"test@example.com\", message: \"Test message\" }) { id emailSent } }"
  }'
```

## å½“å‰ä»£ç çŠ¶æ€

### æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

1. âœ… `cms/lib/email-sender.ts:80` - ä¿®å¤ createTransport æ–¹æ³•å
2. âœ… `cms/lib/email-queue.ts` - æ–°å¢é‚®ä»¶é˜Ÿåˆ—ç³»ç»Ÿ
3. âœ… `cms/schemas/ContactForm.ts:14` - é›†æˆé‚®ä»¶é˜Ÿåˆ—
4. âœ… `cms/schemas/ContactForm.ts:258` - ä½¿ç”¨é˜Ÿåˆ—å‘é€é‚®ä»¶

### é‚®ä»¶é˜Ÿåˆ—ç‰¹æ€§

- **éé˜»å¡**: è¡¨å•æäº¤ç«‹å³è¿”å›,é‚®ä»¶åœ¨åå°å‘é€
- **è‡ªåŠ¨é‡è¯•**: å¤±è´¥åè‡ªåŠ¨é‡è¯• 3 æ¬¡
  - ç¬¬ 1 æ¬¡å¤±è´¥ â†’ 5 ç§’åé‡è¯•
  - ç¬¬ 2 æ¬¡å¤±è´¥ â†’ 10 ç§’åé‡è¯•
  - ç¬¬ 3 æ¬¡å¤±è´¥ â†’ 20 ç§’åé‡è¯•
  - å…¨éƒ¨å¤±è´¥ â†’ è®°å½•é”™è¯¯æ—¥å¿—
- **æ—¥å¿—è®°å½•**: æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„å‘é€çŠ¶æ€

## ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸ (ç«‹å³å¯åš)

1. **é‡å¯ Keystone æœåŠ¡å™¨**
   ```bash
   # åº”ç”¨æœ€æ–°çš„ä»£ç ä¿®æ”¹
   npm run dev
   ```

2. **æäº¤æµ‹è¯•è¡¨å•**
   ```bash
   bash scripts/test-contact-form.sh
   ```

3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**
   - ç¡®è®¤é‚®ä»¶é˜Ÿåˆ—æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### ä¸­æœŸ (å¯é€‰ä¼˜åŒ–)

1. **åˆ›å»º EmailLog æ¨¡å‹**
   - åœ¨æ•°æ®åº“ä¸­è®°å½•æ‰€æœ‰é‚®ä»¶å‘é€å†å²
   - å¯ä»¥åœ¨ CMS ä¸­æŸ¥çœ‹å‘é€çŠ¶æ€

2. **æ·»åŠ é‚®ä»¶é‡å‘åŠŸèƒ½**
   - åœ¨ CMS ä¸­æ·»åŠ "é‡æ–°å‘é€é‚®ä»¶"æŒ‰é’®
   - é’ˆå¯¹å¤±è´¥çš„é‚®ä»¶å¯ä»¥æ‰‹åŠ¨é‡å‘

3. **é›†æˆå¤–éƒ¨é‚®ä»¶æœåŠ¡**
   - ä½¿ç”¨ SendGridã€AWS SES ç­‰ä¸“ä¸šé‚®ä»¶æœåŠ¡
   - æä¾›æ›´é«˜çš„é€è¾¾ç‡å’Œè¯¦ç»†çš„å‘é€ç»Ÿè®¡

## æ•…éšœæ’é™¤æ¸…å•

- [ ] SMTP é…ç½®å®Œæ•´(host, port, user, password)
- [ ] Gmail ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç (ä¸æ˜¯æ™®é€šå¯†ç )
- [ ] ç«¯å£é…ç½®æ­£ç¡®(587 æˆ– 465)
- [ ] formNotificationEmails é…ç½®æ­£ç¡®
- [ ] æœåŠ¡å™¨å¯ä»¥è®¿é—® SMTP ç«¯å£
- [ ] å·²é‡å¯ Keystone æœåŠ¡å™¨(åº”ç”¨ä»£ç ä¿®æ”¹)
- [ ] æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤é‚®ä»¶å¤„ç†çŠ¶æ€
- [ ] æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹

## æŠ€æœ¯æ”¯æŒ

å¦‚æœé—®é¢˜ä»æœªè§£å†³,è¯·æä¾›:

1. SMTP é…ç½®ä¿¡æ¯(ä¸è¦åŒ…å«å¯†ç )
2. Keystone æœåŠ¡å™¨å®Œæ•´æ—¥å¿—
3. ContactForm çš„ emailSent çŠ¶æ€
4. ä½¿ç”¨çš„é‚®ä»¶æœåŠ¡å•†(Gmail, Outlook, ç­‰)

---

**æ–‡æ¡£ç»´æŠ¤**: AI Assistant
**æœ€åæ›´æ–°**: 2025-11-05
**ç›¸å…³æ–‡ä»¶**:
- `cms/lib/email-sender.ts`
- `cms/lib/email-queue.ts`
- `cms/schemas/ContactForm.ts`
