# å¯¼èˆªèœå•å›¾ç‰‡è·å–æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**é€‰æ‹©æ–¹æ¡ˆ**: å‰ç«¯åŠ¨æ€è·å–ç³»åˆ—å›¾ç‰‡

**æ ¸å¿ƒæ€è·¯**:
- NavigationMenu åªå­˜å‚¨èœå•ç»“æ„ï¼ˆåç§°ã€é“¾æ¥ã€ç±»å‹ç­‰ï¼‰
- Shop/Product å­èœå•çš„å›¾ç‰‡ä» ProductSeries çš„ç¬¬ä¸€ä¸ªäº§å“ä¸­è‡ªåŠ¨è·å–
- å‰ç«¯åœ¨è·å–å¯¼èˆªèœå•æ—¶ï¼ŒåŒæ—¶æŸ¥è¯¢äº§å“ç³»åˆ—ï¼Œç„¶ååˆå¹¶æ•°æ®

**ä¼˜ç‚¹**:
- âœ… å›¾ç‰‡å§‹ç»ˆä¿æŒæœ€æ–°ï¼ˆéšäº§å“æ›´æ–°è‡ªåŠ¨æ›´æ–°ï¼‰
- âœ… æ— éœ€ç»´æŠ¤å¯¼èˆªèœå•çš„å›¾ç‰‡å…³è”
- âœ… å‡å°‘æ•°æ®å†—ä½™
- âœ… ç®€åŒ– CMS ç®¡ç†

---

## ğŸ”§ å®ç°æ–¹å¼

### 1. GraphQL æŸ¥è¯¢ï¼ˆå‰ç«¯ï¼‰

```typescript
// lib/graphql/queries/navigation.ts

export const GET_NAVIGATION_WITH_IMAGES = `
  query GetNavigationWithImages($locale: String!) {
    # è·å–å¯¼èˆªèœå•
    navigationMenus(
      where: {
        parent: null,
        visible: { equals: true }
      },
      orderBy: { order: asc }
    ) {
      id
      name
      type
      icon
      link
      order

      children(
        where: { visible: { equals: true } },
        orderBy: { order: asc }
      ) {
        id
        name
        type
        icon
        link
        order

        # å¦‚æœæœ‰æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡ï¼Œä¹Ÿè·å–
        image {
          id
          url
          alt
          width
          height
        }
      }
    }

    # è·å–æ‰€æœ‰æ´»è·ƒçš„äº§å“ç³»åˆ—
    productSeries(
      where: { isActive: { equals: true } }
    ) {
      id
      slug
      name

      # è·å–è¯¥ç³»åˆ—çš„ç¬¬ä¸€ä¸ªå·²å‘å¸ƒäº§å“çš„å°é¢å›¾
      products(
        where: { status: { equals: "PUBLISHED" } },
        orderBy: { createdAt: desc },
        take: 1
      ) {
        id
        coverImage {
          id
          url
          alt
          width
          height
        }
      }
    }
  }
`
```

---

### 2. æ•°æ®å¤„ç†å‡½æ•°ï¼ˆå‰ç«¯ï¼‰

```typescript
// lib/navigation/enrichNavigationWithImages.ts

import type { NavigationMenu, ProductSeries } from '@/types'

interface EnrichedNavigationMenu extends NavigationMenu {
  children?: Array<NavigationMenu & { image?: ImageData }>
}

/**
 * ä¸ºå¯¼èˆªèœå•å­é¡¹è‡ªåŠ¨æ·»åŠ äº§å“ç³»åˆ—å›¾ç‰‡
 */
export function enrichNavigationWithImages(
  menus: NavigationMenu[],
  productSeries: ProductSeries[]
): EnrichedNavigationMenu[] {
  // åˆ›å»ºç³»åˆ— slug -> å›¾ç‰‡çš„æ˜ å°„
  const seriesImageMap = new Map<string, ImageData>(
    productSeries
      .filter(series => series.products && series.products.length > 0)
      .map(series => [
        series.slug,
        series.products[0].coverImage
      ])
  )

  // ä¸ºæ¯ä¸ªèœå•é¡¹å¤„ç†
  return menus.map(menu => {
    // åªå¤„ç† Shop å’Œ Product èœå•
    const needsImages = ['Shop', 'Product'].includes(menu.name.en)

    if (!needsImages || !menu.children) {
      return menu
    }

    return {
      ...menu,
      children: menu.children.map(child => {
        // å¦‚æœå·²ç»æœ‰æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡ï¼Œä¼˜å…ˆä½¿ç”¨
        if (child.image) {
          return child
        }

        // ä» link ä¸­æå–ç³»åˆ— slug
        const seriesSlug = extractSeriesSlug(child.link)

        if (!seriesSlug) {
          console.warn(`Cannot extract series slug from link: ${child.link}`)
          return child
        }

        // ä»æ˜ å°„ä¸­è·å–å›¾ç‰‡
        const image = seriesImageMap.get(seriesSlug)

        return {
          ...child,
          image: image || null
        }
      })
    }
  })
}

/**
 * ä»é“¾æ¥ä¸­æå–ç³»åˆ— slug
 *
 * æ”¯æŒä¸¤ç§æ ¼å¼:
 * - /shop?series=glass-standoff  (Shop èœå•)
 * - /product/glass-standoff       (Product èœå•)
 */
function extractSeriesSlug(link: string): string | null {
  // åŒ¹é… /shop?series=xxx
  const shopMatch = link.match(/series=([^&]+)/)
  if (shopMatch) {
    return shopMatch[1]
  }

  // åŒ¹é… /product/xxx
  const productMatch = link.match(/\/product\/([^/?]+)/)
  if (productMatch) {
    return productMatch[1]
  }

  return null
}
```

---

### 3. API Routeï¼ˆServer Component ç”¨ï¼‰

```typescript
// app/api/navigation/route.ts

import { NextResponse } from 'next/server'
import { getContext } from '@/lib/keystone'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const locale = searchParams.get('locale') || 'en'

  try {
    const context = await getContext()

    // è·å–å¯¼èˆªèœå•
    const menus = await context.query.NavigationMenu.findMany({
      where: {
        parent: null,
        visible: true
      },
      orderBy: { order: 'asc' },
      query: `
        id
        name
        type
        icon
        link
        order
        children(
          where: { visible: true },
          orderBy: { order: asc }
        ) {
          id
          name
          type
          icon
          link
          order
          image {
            id
            url
            alt
            width
            height
          }
        }
      `
    })

    // è·å–äº§å“ç³»åˆ—
    const series = await context.query.ProductSeries.findMany({
      where: { isActive: true },
      query: `
        id
        slug
        name
        products(
          where: { status: "PUBLISHED" },
          orderBy: { createdAt: desc },
          take: 1
        ) {
          id
          coverImage {
            id
            url
            alt
            width
            height
          }
        }
      `
    })

    // åˆå¹¶æ•°æ®
    const enrichedMenus = enrichNavigationWithImages(menus, series)

    return NextResponse.json({
      success: true,
      data: enrichedMenus
    })

  } catch (error) {
    console.error('Error fetching navigation:', error)
    return NextResponse.json(
      { success: false, error: 'Failed to fetch navigation' },
      { status: 500 }
    )
  }
}
```

---

### 4. React Hookï¼ˆå®¢æˆ·ç«¯ä½¿ç”¨ï¼‰

```typescript
// hooks/useNavigation.ts

import { useQuery } from '@tanstack/react-query'
import { enrichNavigationWithImages } from '@/lib/navigation/enrichNavigationWithImages'

interface UseNavigationOptions {
  locale?: string
}

export function useNavigation(options: UseNavigationOptions = {}) {
  const { locale = 'en' } = options

  return useQuery({
    queryKey: ['navigation', locale],
    queryFn: async () => {
      const response = await fetch(`/api/navigation?locale=${locale}`)

      if (!response.ok) {
        throw new Error('Failed to fetch navigation')
      }

      const { data } = await response.json()
      return data
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
    cacheTime: 10 * 60 * 1000, // 10 minutes
  })
}
```

---

### 5. Server Component ä½¿ç”¨ï¼ˆæ¨èï¼‰

```typescript
// app/components/Header/Navigation.tsx

import { getContext } from '@/lib/keystone'
import { enrichNavigationWithImages } from '@/lib/navigation/enrichNavigationWithImages'
import { NavigationClient } from './NavigationClient'

export async function Navigation() {
  const context = await getContext()

  // è·å–å¯¼èˆªèœå•
  const menus = await context.query.NavigationMenu.findMany({
    where: { parent: null, visible: true },
    orderBy: { order: 'asc' },
    query: `
      id name type icon link order
      children(where: { visible: true }, orderBy: { order: asc }) {
        id name type icon link order
        image { id url alt width height }
      }
    `
  })

  // è·å–äº§å“ç³»åˆ—
  const series = await context.query.ProductSeries.findMany({
    where: { isActive: true },
    query: `
      id slug name
      products(
        where: { status: "PUBLISHED" },
        orderBy: { createdAt: desc },
        take: 1
      ) {
        coverImage { id url alt width height }
      }
    `
  })

  // åˆå¹¶æ•°æ®
  const enrichedMenus = enrichNavigationWithImages(menus, series)

  return <NavigationClient menus={enrichedMenus} />
}
```

---

### 6. å®¢æˆ·ç«¯ç»„ä»¶æ¸²æŸ“

```typescript
// app/components/Header/NavigationClient.tsx

'use client'

import Link from 'next/link'
import Image from 'next/image'
import { ChevronDown } from 'lucide-react'
import { useState } from 'react'

export function NavigationClient({ menus }) {
  const [activeMenu, setActiveMenu] = useState<string | null>(null)

  return (
    <nav className="flex items-center gap-8">
      {menus.map(menu => (
        <div key={menu.id} className="relative group">
          {/* ä¸€çº§èœå• */}
          <div className="flex items-center gap-1">
            {menu.link ? (
              <Link
                href={menu.link}
                className="text-gray-700 hover:text-blue-600 transition-colors"
              >
                {menu.name.en}
              </Link>
            ) : (
              <span className="text-gray-700">{menu.name.en}</span>
            )}

            {/* ä¸‹æ‹‰æŒ‰é’® */}
            {menu.children && menu.children.length > 0 && (
              <button
                onClick={() => setActiveMenu(activeMenu === menu.id ? null : menu.id)}
                className="p-1 hover:bg-gray-100 rounded"
              >
                <ChevronDown className="w-4 h-4" />
              </button>
            )}
          </div>

          {/* å­èœå• */}
          {menu.children && activeMenu === menu.id && (
            <div className="absolute top-full left-0 mt-2 bg-white shadow-lg rounded-lg p-4 z-50">
              {menu.type === 'PRODUCT_CARDS' ? (
                // äº§å“å¡ç‰‡ç½‘æ ¼
                <div className="grid grid-cols-4 gap-4 w-[800px]">
                  {menu.children.map(child => (
                    <Link
                      key={child.id}
                      href={child.link}
                      className="block group/card hover:shadow-md transition-shadow rounded-lg overflow-hidden"
                    >
                      {child.image && (
                        <div className="relative aspect-square">
                          <Image
                            src={child.image.url}
                            alt={child.image.alt || child.name.en}
                            fill
                            className="object-cover group-hover/card:scale-105 transition-transform"
                          />
                        </div>
                      )}
                      <div className="p-3">
                        <h3 className="font-medium text-sm text-gray-900">
                          {child.name.en}
                        </h3>
                      </div>
                    </Link>
                  ))}
                </div>
              ) : menu.type === 'SUBMENU' ? (
                // å¸¦å›¾æ ‡çš„å­èœå•
                <div className="flex flex-col gap-2 min-w-[200px]">
                  {menu.children.map(child => (
                    <Link
                      key={child.id}
                      href={child.link}
                      className="flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-md transition-colors"
                    >
                      {child.icon && <Icon name={child.icon} className="w-5 h-5" />}
                      <span>{child.name.en}</span>
                    </Link>
                  ))}
                </div>
              ) : (
                // æ™®é€šä¸‹æ‹‰èœå•
                <div className="flex flex-col gap-1 min-w-[180px]">
                  {menu.children.map(child => (
                    <Link
                      key={child.id}
                      href={child.link}
                      className="px-3 py-2 hover:bg-gray-50 rounded-md transition-colors"
                    >
                      {child.name.en}
                    </Link>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      ))}
    </nav>
  )
}
```

---

## ğŸ¯ å·¥ä½œæµç¨‹

### æ•°æ®æµ

```
1. å‰ç«¯è¯·æ±‚å¯¼èˆªèœå•
   â†“
2. API/Server Component æŸ¥è¯¢:
   - NavigationMenu (èœå•ç»“æ„)
   - ProductSeries (ç³»åˆ—åŠäº§å“å›¾ç‰‡)
   â†“
3. enrichNavigationWithImages() å‡½æ•°:
   - åˆ›å»º slug -> image æ˜ å°„
   - ä» link æå– slug
   - ä¸ºå­èœå•æ·»åŠ å¯¹åº”å›¾ç‰‡
   â†“
4. è¿”å›å®Œæ•´çš„å¯¼èˆªæ•°æ® (åŒ…å«å›¾ç‰‡)
   â†“
5. å‰ç«¯æ¸²æŸ“å¯¼èˆªèœå•
```

### å›¾ç‰‡æ›´æ–°æµç¨‹

```
1. CMS ç®¡ç†å‘˜ä¸Šä¼ æ–°äº§å“å›¾ç‰‡
   â†“
2. ä¸‹æ¬¡å‰ç«¯è¯·æ±‚å¯¼èˆªèœå•æ—¶
   â†“
3. è‡ªåŠ¨è·å–æœ€æ–°çš„äº§å“å›¾ç‰‡
   â†“
4. å¯¼èˆªèœå•æ˜¾ç¤ºæ›´æ–°åçš„å›¾ç‰‡
```

**æ— éœ€é¢å¤–æ“ä½œï¼**

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

```typescript
// Next.js App Router - Server Component
export const revalidate = 300 // 5 minutes

// React Query - Client Component
{
  staleTime: 5 * 60 * 1000,   // 5 minutes
  cacheTime: 10 * 60 * 1000,  // 10 minutes
}
```

### 2. æ•°æ®é¢„åŠ è½½

```typescript
// app/layout.tsx
export async function generateStaticParams() {
  // é¢„åŠ è½½å¯¼èˆªæ•°æ®
  await getNavigation()
}
```

### 3. å›¾ç‰‡ä¼˜åŒ–

```typescript
// ä½¿ç”¨ Next.js Image ç»„ä»¶è‡ªåŠ¨ä¼˜åŒ–
<Image
  src={child.image.url}
  alt={child.image.alt}
  width={300}
  height={300}
  quality={85}
  priority={false} // æ‡’åŠ è½½
/>
```

---

## ğŸ” æµ‹è¯•åœºæ™¯

### 1. æ— å›¾ç‰‡çš„ç³»åˆ—

å¦‚æœæŸä¸ªç³»åˆ—æš‚æ—¶æ²¡æœ‰äº§å“æˆ–äº§å“æ²¡æœ‰å›¾ç‰‡ï¼š

```typescript
// æ˜¾ç¤ºå ä½å›¾
{child.image ? (
  <Image src={child.image.url} alt={child.name.en} />
) : (
  <div className="aspect-square bg-gray-200 flex items-center justify-center">
    <span className="text-gray-400">No Image</span>
  </div>
)}
```

### 2. æ‰‹åŠ¨è¦†ç›–

å¦‚æœè¿è¥äººå‘˜åœ¨ CMS ä¸­ä¸ºæŸä¸ªèœå•é¡¹æ‰‹åŠ¨è®¾ç½®äº†å›¾ç‰‡ï¼š

```typescript
// enrichNavigationWithImages() ä¼šä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡
if (child.image) {
  return child // ä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡
}
```

### 3. é“¾æ¥æ ¼å¼é”™è¯¯

å¦‚æœé“¾æ¥æ ¼å¼ä¸åŒ¹é…ï¼š

```typescript
// extractSeriesSlug() è¿”å› null
// è¯¥èœå•é¡¹ä¸æ˜¾ç¤ºå›¾ç‰‡
console.warn(`Cannot extract series slug from link: ${child.link}`)
```

---

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¡®ä¿æ‰€æœ‰äº§å“ç³»åˆ—è‡³å°‘æœ‰ä¸€ä¸ªå·²å‘å¸ƒçš„äº§å“
- [ ] ç¡®ä¿äº§å“çš„ coverImage å·²è®¾ç½®
- [ ] æµ‹è¯•ä¸åŒè¯­è¨€ä¸‹çš„å¯¼èˆªèœå•
- [ ] æµ‹è¯•ç¼“å­˜åˆ·æ–°ï¼ˆäº§å“å›¾ç‰‡æ›´æ–°åï¼‰
- [ ] æµ‹è¯•æ€§èƒ½ï¼ˆå¤§é‡äº§å“ç³»åˆ—çš„æƒ…å†µï¼‰
- [ ] æµ‹è¯• SEOï¼ˆç¡®ä¿å›¾ç‰‡æœ‰æ­£ç¡®çš„ alt æ–‡æœ¬ï¼‰

---

## ğŸ“ ç»´æŠ¤æŒ‡å—

### æ·»åŠ æ–°çš„äº§å“ç³»åˆ—

1. åœ¨ CMS ä¸­åˆ›å»ºæ–°çš„ ProductSeries
2. ä¸ºè¯¥ç³»åˆ—æ·»åŠ è‡³å°‘ä¸€ä¸ªäº§å“å¹¶è®¾ç½®å°é¢å›¾
3. åœ¨ NavigationMenu ä¸­æ·»åŠ å¯¹åº”çš„å­èœå•é¡¹
4. é“¾æ¥æ ¼å¼ï¼š`/shop?series={slug}` æˆ– `/product/{slug}`
5. å‰ç«¯ä¼šè‡ªåŠ¨è·å–å¹¶æ˜¾ç¤ºå›¾ç‰‡ âœ…

### æ›´æ–°äº§å“å›¾ç‰‡

1. åœ¨ CMS ä¸­æ›´æ–°äº§å“çš„ coverImage
2. ç­‰å¾…ç¼“å­˜è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰æˆ–æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
3. å¯¼èˆªèœå•ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ–°å›¾ç‰‡ âœ…

### æ‰‹åŠ¨è®¾ç½®èœå•å›¾ç‰‡

1. åœ¨ CMS Admin UI è¿›å…¥ Navigation Menus
2. ç¼–è¾‘ç›®æ ‡å­èœå•é¡¹
3. åœ¨ "Card Image" å­—æ®µé€‰æ‹©ä¸€ä¸ª Media
4. ä¿å­˜
5. è¯¥èœå•é¡¹ä¼šä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡ âœ…

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-04
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
