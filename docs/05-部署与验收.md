# 05 部署与验收

**文档版本**: v2.0
**技术栈**: AWS EC2 + RDS + S3 + CloudFront
**最后更新**: 2025-11-04

---

## 文档导航

- [01-数据模型与架构](./01-数据模型与架构.md)
- [02-API接口规范](./02-API接口规范.md)
- [03-CMS后台功能](./03-CMS后台功能.md)
- [04-安全与性能](./04-安全与性能.md)
- **当前文档**: 05-部署与验收

---

## 🚀 部署指南

### 开发环境启动

```bash
# 1. 启动MinIO和Nginx
docker-compose up -d

# 2. 数据库迁移
npx keystone dev --reset-db

# 3. 启动Keystone
npm run dev
```

### 生产环境部署

```bash
# 1. 构建
npm run build

# 2. 数据库迁移
npx keystone deploy

# 3. 启动生产服务器
npm run start
```

### 环境变量配置

```env
# .env.production
DATABASE_URL="postgresql://user:pass@rds.amazonaws.com:5432/busrom"
SESSION_SECRET="your-super-secret-session-key"

# AWS S3
S3_BUCKET_NAME="busrom-media"
S3_REGION="us-east-1"
S3_ACCESS_KEY_ID="AKIA..."
S3_SECRET_ACCESS_KEY="..."

# Redis
REDIS_HOST="redis.busrom.internal"
REDIS_PORT="6379"
REDIS_PASSWORD="..."

# SMTP
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_USER="noreply@busrom.com"
SMTP_PASSWORD="..."

# 第三方服务
GOOGLE_ANALYTICS_ID="G-XXXXXXXXXX"
RECAPTCHA_SECRET_KEY="..."
INDEX_NOW_KEY="..."

# 应用配置
NODE_ENV="production"
PORT="3000"
FRONTEND_URL="https://busrom.com"
ADMIN_URL="https://admin.busrom.com"
```

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有数据模型已创建并测试
- [ ] API接口文档完整且可用
- [ ] CMS后台功能完整
- [ ] 表单提交和邮件通知正常
- [ ] SEO自动化功能正常

### 性能指标
- [ ] API响应时间 < 200ms
- [ ] 图片加载时间 < 1s
- [ ] 数据库查询优化完成
- [ ] Redis缓存命中率 > 80%

### 安全标准
- [ ] HTTPS强制启用
- [ ] SQL注入防护测试通过
- [ ] XSS防护测试通过
- [ ] CSRF防护启用
- [ ] 权限控制测试通过

### SEO要求
- [ ] Sitemap自动生成
- [ ] Meta标签完整
- [ ] 结构化数据正确
- [ ] IndexNow推送成功
- [ ] Google Search Console验证通过

---

## 完整数据模型总结

本项目包含以下8个核心数据模型:

### 1. ContactForm (联系表单)
用于存储用户提交的咨询和询价数据,支持状态管理和邮件通知。

### 2. CustomScript (自定义代码管理)
强大的脚本管理系统,支持:
- 全局/页面级别的脚本注入
- 多种应用范围(页面类型、精确路径、通配符、关联内容)
- 脚本安全验证
- 优先级和加载方式控制

### 3. SeoSetting (SEO设置)
全局和单页SEO配置,包括:
- Meta标签管理
- Open Graph支持
- 结构化数据
- Robots控制
- 规范URL

### 4. SiteConfig (站点配置)
单例模式的全局配置,包含:
- 公司基本信息
- 联系方式和社交媒体
- 第三方服务API密钥
- 邮件服务配置
- 功能开关

### 5. NavigationMenu (导航菜单)
灵活的多级菜单管理,支持:
- 头部/底部/移动端导航
- 父子级关联
- 拖拽排序
- 图标和样式控制

### 6. HomeContent (首页内容配置)
JSON格式存储首页各区块配置,包括:
- Hero Banner
- 服务特点
- 品牌优势
- 各种CTA区块

### 7. User (管理员用户)
用户管理系统,支持:
- 多角色权限(admin/editor/reviewer/support)
- 双因素认证
- 登录记录

### 8. ActivityLog (操作日志)
完整的审计系统,记录:
- 所有CRUD操作
- 用户信息和IP地址
- 操作详细信息

---

## API接口总结

本项目提供10个主要API接口组:

1. **首页数据接口** - 聚合多种内容类型
2. **产品系列接口** - 列表和详情查询
3. **产品(SKU)接口** - 支持筛选和搜索
4. **博客接口** - 文章管理和展示
5. **应用案例接口** - 案例展示系统
6. **FAQ接口** - 常见问题管理
7. **表单提交接口** - 前端表单处理
8. **站点配置接口** - 全局设置读取
9. **导航菜单接口** - 动态菜单生成
10. **SEO相关接口** - Sitemap和IndexNow

---

## CMS后台功能总结

后台管理系统包含8个核心模块:

1. **内容管理模块**
   - 富文本编辑器
   - 多图上传
   - 自定义组件

2. **媒体管理模块**
   - 媒体库
   - 自动优化
   - 多尺寸生成

3. **栏目/导航管理**
   - 拖拽排序
   - 多级菜单
   - 可视化配置

4. **SEO设置面板**
   - 全局SEO配置
   - 动态Robots.txt
   - Meta标签管理

5. **自定义代码插入**
   - 脚本编辑器
   - 安全验证
   - 实时预览

6. **表单管理界面**
   - 列表筛选
   - CSV导出
   - 邮件回复

7. **用户权限管理**
   - 基于角色的访问控制
   - 字段级权限
   - 操作日志

8. **系统设置面板**
   - 分组字段显示
   - 配置预览
   - 自动任务触发

---

## 安全与性能措施

### 安全措施
- ✅ reCAPTCHA v3集成
- ✅ 请求频率限制
- ✅ 脚本安全验证
- ✅ 权限控制系统
- ✅ 操作日志审计

### 性能优化
- ✅ Redis缓存层
- ✅ 数据库索引优化
- ✅ GraphQL DataLoader(避免N+1)
- ✅ 图片自动优化(WebP、多尺寸)
- ✅ CDN集成(CloudFront)

### 开发环境
- ✅ MinIO本地对象存储
- ✅ Nginx反向代理
- ✅ Docker Compose编排

---

## 开发里程碑

### Week 1-2: 基础架构
完成Keystone 6初始化、数据库配置、存储集成和数据模型定义

### Week 3-4: CMS核心功能
实现富文本编辑、媒体管理、导航配置和SEO设置

### Week 5: 表单和邮件系统
完成表单提交、邮件通知、验证码集成和后台管理

### Week 6: 高级功能
实现自定义代码管理、日志系统和权限控制

### Week 7: SEO自动化
完成Sitemap生成、IndexNow集成和结构化数据

### Week 8: 性能优化和测试
部署Redis缓存、优化数据库、配置CDN和进行测试

### Week 9-10: 部署和监控
完成生产环境部署、监控配置和文档完善

---

## 技术栈总结

### 后端
- **CMS框架**: Keystone 6
- **数据库**: PostgreSQL
- **缓存**: Redis
- **语言**: Node.js + TypeScript

### 存储
- **开发环境**: MinIO + Nginx
- **生产环境**: AWS S3 + CloudFront CDN

### 部署
- **计算**: AWS EC2
- **数据库**: AWS RDS
- **监控**: CloudWatch

### 第三方服务
- **邮件**: SMTP (Gmail/SendGrid)
- **验证码**: Google reCAPTCHA v3
- **分析**: Google Analytics
- **SEO**: Google Search Console + IndexNow

---

## 项目亮点

### 1. 灵活的自定义代码系统
支持全局和页面级别的脚本注入,具有强大的应用范围控制和安全验证机制。

### 2. 完整的SEO自动化
自动生成Sitemap、支持IndexNow实时推送、结构化数据和Open Graph标签。

### 3. 强大的权限系统
基于角色的访问控制,支持操作级和字段级权限,配合完整的审计日志。

### 4. 智能缓存策略
Redis缓存层配合自动失效机制,显著提升API响应速度。

### 5. 图片优化Pipeline
自动生成多尺寸版本和WebP格式,配合CDN实现最优加载性能。

### 6. 灵活的内容管理
JSON格式存储复杂配置,支持动态区块和自定义字段,便于前端灵活调用。

---

## 后续改进建议

### 短期改进
1. 实现内容版本控制和历史记录
2. 添加内容审核工作流
3. 支持多语言内容管理
4. 实现定时发布功能

### 中期改进
1. 集成Elasticsearch全文搜索
2. 添加内容推荐算法
3. 实现A/B测试功能
4. 开发移动端管理应用

### 长期规划
1. 多站点管理支持
2. 无头CMS API扩展
3. 插件系统开发
4. AI辅助内容创作

---

## 文档使用指南

### 开发人员
1. 首先阅读 [01-数据模型与架构](./01-数据模型与架构.md) 了解系统结构
2. 参考 [02-API接口规范](./02-API接口规范.md) 进行前端集成
3. 查看 [04-安全与性能](./04-安全与性能.md) 了解最佳实践

### 内容管理员
1. 阅读 [03-CMS后台功能](./03-CMS后台功能.md) 学习后台操作
2. 了解表单管理和SEO设置功能
3. 掌握自定义代码插入的安全规范

### 运维人员
1. 参考本文档的部署指南进行环境配置
2. 按照验收标准进行系统检查
3. 配置监控和备份策略

---

## 技术支持

### 常见问题
- Keystone 6官方文档: https://keystonejs.com
- GraphQL文档: https://graphql.org
- Next.js集成指南: https://nextjs.org

### 联系方式
- 技术支持邮箱: dev@busrom.com
- 项目Wiki: [内部链接]
- 问题追踪: [GitHub Issues]

---

**文档维护**: 开发团队
**最后审核**: 2025-11-04
**项目状态**: 开发中
