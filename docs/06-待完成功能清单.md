# 06 待完成功能清单

**文档版本**: v1.0
**创建日期**: 2025-11-05
**状态**: 待处理

---

## 文档导航

- [01-数据模型与架构](./01-数据模型与架构.md)
- [02-API接口规范](./02-API接口规范.md)
- [03-CMS后台功能](./03-CMS后台功能.md)
- [04-安全与性能](./04-安全与性能.md)
- [05-部署与验收](./05-部署与验收.md)
- **当前文档**: 06-待完成功能清单

---

## 📋 概述

本文档列出了在 **User (管理员用户)** 数据模型之前的所有数据模型和后台功能中，尚未完成或字段没有实际作用的部分。

根据对 `docs/01-数据模型与架构.md` 和 `docs/03-CMS后台功能.md` 的分析，以下功能需要进一步检查或完成实现。

---

## ✅ 已完成的模型及功能

### 1. ContactForm (联系表单)
- ✅ 数据模型完整
- ✅ 后台列表视图
- ⚠️ **邮件发送功能需要验证** (见下方详细说明)

### 2. CustomScript (自定义代码管理)
- ✅ 数据模型完整
- ✅ 后台脚本验证和预览
- ⚠️ **前端脚本注入逻辑需要验证** (见下方详细说明)

### 3. SeoSetting (SEO设置)
- ✅ 数据模型完整
- ✅ 全局/单页SEO配置
- ⚠️ **Sitemap/Robots.txt自动生成需要验证** (见下方详细说明)

### 4. SiteConfig (站点全局配置)
- ✅ 数据模型完整
- ✅ 后台分组显示
- ⚠️ **配置变更后的缓存清理需要验证** (见下方详细说明)

### 5. NavigationMenu (导航菜单)
- ✅ 数据模型完整
- ⚠️ **拖拽排序功能需要验证** (见下方详细说明)

### 6. HomeContent (首页内容配置)
- ✅ 数据模型完整
- ✅ 后台自定义字段编辑器

### 7. Footer (页脚配置)
- ✅ 数据模型完整
- ✅ Singleton模式实现

---

## ⚠️ 待检查/完成的功能

### 任务1: NavigationMenu - 拖拽排序功能

**优先级**: 🟡 中等

**问题描述**:
- 数据模型中有 `order` 字段用于排序
- `docs/03-CMS后台功能.md` 中展示了拖拽排序的代码示例
- **但未确认是否已实际实现并部署到项目中**

**涉及文件**:
- `cms/schema/NavigationMenu.ts` (数据模型)
- `admin/pages/navigation-manager.tsx` (自定义页面 - 可能不存在)
- `package.json` (依赖检查)

**需要检查**:
1. [ ] 确认 `admin/pages/navigation-manager.tsx` 文件是否存在
2. [ ] 确认是否已安装拖拽库依赖:
   - `@dnd-kit/core`
   - `@dnd-kit/sortable`
3. [ ] 确认是否在 Keystone Admin UI 中注册了自定义页面
4. [ ] 测试拖拽排序功能是否正常工作

**实现步骤** (如果不存在):
1. 安装依赖: `npm install @dnd-kit/core @dnd-kit/sortable`
2. 创建 `admin/pages/navigation-manager.tsx` 文件
3. 实现拖拽排序逻辑 (参考 docs/03-CMS后台功能.md 第306-347行)
4. 在 Keystone 配置中注册自定义页面
5. 创建批量更新 order 的 GraphQL Mutation

**影响**:
- 如果未实现: 运营人员需要手动修改每个菜单项的 `order` 数字，操作繁琐
- 如果已实现: 可以直接拖拽调整菜单顺序，提升用户体验

---

### 任务2: Media - 图片自动优化和多尺寸生成

**优先级**: 🔴 高

**问题描述**:
- 数据模型中有 `variants` 字段用于存储多尺寸图片
- 数据模型中有 `width`、`height`、`fileSize`、`mimeType` 等元数据字段
- hooks 中有 `afterOperation` 的逻辑调用 `generateImageVariants()`
- **但这些辅助函数和优化逻辑可能未实际实现**

**涉及文件**:
- `cms/schema/Media.ts` (数据模型)
- `lib/image-optimizer.ts` (图片优化逻辑 - 可能不存在)
- `keystone.ts` (S3存储配置)

**需要检查**:
1. [ ] 确认 `lib/image-optimizer.ts` 文件是否存在
2. [ ] 确认 `generateImageVariants()` 函数是否已实现
3. [ ] 确认 `extractImageMetadata()` 函数是否已实现
4. [ ] 确认 S3 存储配置是否完整
5. [ ] 确认 `sharp` 依赖是否已安装
6. [ ] 测试图片上传后是否自动生成:
   - 缩略图 (150x150)
   - 小尺寸 (400px)
   - 中尺寸 (800px)
   - 大尺寸 (1200px)
   - WebP格式

**实现步骤** (如果不存在):
1. 安装依赖: `npm install sharp @aws-sdk/client-s3`
2. 创建 `lib/image-optimizer.ts` 文件
3. 实现 `generateImageVariants()` 函数 (参考 docs/03-CMS后台功能.md 第256-282行)
4. 实现 `extractImageMetadata()` 函数
5. 在 Media 模型的 hooks 中调用这些函数
6. 配置 S3 存储的 `generateUrl` 选项

**影响**:
- 如果未实现:
  - 前端加载原始大图，影响页面性能
  - 无法使用现代 WebP 格式，影响 SEO 和加载速度
  - 无法自动生成缩略图，后台媒体库体验差
- 如果已实现:
  - 自动生成多尺寸图片，提升加载速度
  - 支持响应式图片，优化移动端体验

---

### 任务3: CustomScript - 前端脚本注入逻辑

**优先级**: 🟡 中等

**问题描述**:
- 后台可以配置各种追踪代码 (Google Analytics, TikTok Pixel等)
- 后台有 `scope`、`pageType`、`pathPattern`、`scriptPosition` 等配置
- **但前端 Next.js 如何读取这些配置并动态注入脚本的逻辑可能未实现**

**涉及文件**:
- `cms/schema/CustomScript.ts` (数据模型)
- `app/layout.tsx` (根布局)
- `components/ScriptInjector.tsx` (脚本注入组件 - 可能不存在)
- `lib/api/custom-scripts.ts` (API调用 - 可能不存在)

**需要检查**:
1. [ ] 确认前端是否有读取 CustomScript 数据的 API 调用
2. [ ] 确认是否有 `<ScriptInjector>` 或类似组件
3. [ ] 确认是否根据 `scope` 条件动态加载脚本:
   - `global`: 所有页面加载
   - `page_type`: 根据页面类型加载
   - `exact_path`: 精确路径匹配
   - `path_pattern`: 通配符匹配
   - `related_content`: 关联内容加载
4. [ ] 确认是否根据 `scriptPosition` 注入到正确位置:
   - `header`: 插入到 `<head>` 中
   - `footer`: 插入到 `</body>` 前
   - `body_start`: 插入到 `<body>` 开始
5. [ ] 确认是否支持 `async` 和 `defer` 属性
6. [ ] 确认是否按 `priority` 排序加载

**实现步骤** (如果不存在):
1. 创建 `lib/api/custom-scripts.ts` 文件
2. 实现 GraphQL 查询获取启用的脚本
3. 创建 `components/ScriptInjector.tsx` 组件
4. 实现脚本匹配逻辑 (根据 scope)
5. 在 `app/layout.tsx` 中使用 `<ScriptInjector>`
6. 使用 `next/script` 组件处理脚本加载

**影响**:
- 如果未实现:
  - 运营人员配置的追踪代码无法生效
  - Google Analytics、TikTok Pixel 等无法正常工作
- 如果已实现:
  - 可以通过后台灵活配置追踪代码
  - 无需修改代码即可添加/删除脚本

---

### 任务4: SeoSetting - Sitemap/Robots.txt自动生成

**优先级**: 🔴 高

**问题描述**:
- 数据模型中有 SEO 相关配置
- SiteConfig 中有 `robotsTxtContent` 字段
- `docs/03-CMS后台功能.md` 中展示了 `robots.txt` 的路由代码
- **但 `sitemap.xml` 和 `robots.txt` 的动态生成逻辑可能未实现**

**涉及文件**:
- `app/sitemap.xml/route.ts` (可能不存在)
- `app/robots.txt/route.ts` (可能不存在)
- `lib/api/seo.ts` (API调用 - 可能不存在)

**需要检查**:
1. [ ] 确认 `app/sitemap.xml/route.ts` 是否存在
2. [ ] 确认 `app/robots.txt/route.ts` 是否存在
3. [ ] 确认 Sitemap 是否包含所有动态页面:
   - 产品系列页面 (`/product/[series]`)
   - 产品详情页面 (`/shop/[sku]`)
   - 博客文章页面 (`/about-us/blog/[slug]`)
   - 应用案例页面 (`/service/application/[id]`)
4. [ ] 确认 Sitemap 是否包含正确的:
   - `lastmod` (最后修改时间)
   - `changefreq` (更新频率)
   - `priority` (优先级)
5. [ ] 确认是否支持多语言 Sitemap (24种语言)
6. [ ] 确认 Robots.txt 是否读取 SiteConfig 配置

**实现步骤** (如果不存在):
1. 创建 `app/sitemap.xml/route.ts` 文件
2. 实现动态生成 Sitemap 的逻辑:
   ```typescript
   export async function GET() {
     const products = await getProducts();
     const blogs = await getBlogs();
     const applications = await getApplications();

     const urls = [
       { url: '/', lastmod: new Date(), priority: 1.0 },
       ...products.map(p => ({ url: `/shop/${p.sku}`, lastmod: p.updatedAt, priority: 0.8 })),
       ...blogs.map(b => ({ url: `/about-us/blog/${b.slug}`, lastmod: b.updatedAt, priority: 0.6 })),
     ];

     return new Response(generateSitemapXML(urls), {
       headers: { 'Content-Type': 'application/xml' }
     });
   }
   ```
3. 创建 `app/robots.txt/route.ts` 文件 (参考 docs/03-CMS后台功能.md 第406-418行)
4. 实现 IndexNow 协议支持 (如果需要)

**影响**:
- 如果未实现:
  - 搜索引擎爬虫无法发现所有页面
  - SEO 效果大打折扣
  - 新页面无法及时被索引
- 如果已实现:
  - 搜索引擎可以快速发现和索引新内容
  - 提升 SEO 排名和流量

---

### 任务5: ContactForm - 邮件自动发送功能

**优先级**: 🔴 高

**问题描述**:
- 数据模型中有 `emailSent` 字段
- hooks 中有 `afterOperation` 的 TODO 注释: `// await sendEmailNotification(item);`
- SiteConfig 中有 SMTP 配置和自动回复模板
- **但邮件发送逻辑可能未实际实现**

**涉及文件**:
- `cms/schema/ContactForm.ts` (数据模型)
- `lib/email-sender.ts` (邮件发送逻辑 - 可能不存在)
- `cms/schema/SiteConfig.ts` (SMTP配置)

**需要检查**:
1. [ ] 确认 `lib/email-sender.ts` 文件是否存在
2. [ ] 确认 `sendContactFormNotification()` 函数是否已实现
3. [ ] 确认 SMTP 配置是否可用 (SiteConfig)
4. [ ] 确认表单提交后是否自动发送:
   - 管理员通知邮件
   - 客户自动回复邮件 (如果启用)
5. [ ] 确认邮件模板是否正确
6. [ ] 确认是否更新 `emailSent` 字段

**实现步骤** (如果不存在):
1. 安装依赖: `npm install nodemailer @types/nodemailer`
2. 创建 `lib/email-sender.ts` 文件
3. 实现 `sendContactFormNotification()` 函数 (参考 docs/03-CMS后台功能.md 第651-701行)
4. 在 ContactForm 的 hooks 中调用邮件发送函数
5. 添加错误处理和重试机制
6. 测试邮件发送功能

**影响**:
- 如果未实现:
  - 客服无法及时收到客户咨询
  - 客户无法收到自动回复，体验差
  - 可能错失商机
- 如果已实现:
  - 客服可以及时响应客户
  - 客户得到即时反馈，提升体验

---

### 任务6: SiteConfig - 配置变更后的缓存清理

**优先级**: 🟡 中等

**问题描述**:
- `docs/03-CMS后台功能.md` 中提到配置修改后需要清除缓存
- hooks 中有 `afterOperation` 调用 `clearCache('site-config')`
- **但缓存清理逻辑可能未实际实现**

**涉及文件**:
- `cms/schema/SiteConfig.ts` (数据模型)
- `lib/cache.ts` (缓存管理 - 可能不存在)

**需要检查**:
1. [ ] 确认 `lib/cache.ts` 文件是否存在
2. [ ] 确认 `clearCache()` 函数是否已实现
3. [ ] 确认使用的缓存方案:
   - Redis
   - Next.js 内置缓存
   - 其他缓存方案
4. [ ] 确认配置修改后是否触发:
   - 前端缓存清理
   - CDN 缓存清理 (如果使用)
5. [ ] 确认是否重新生成 Sitemap (当 SEO 配置变更时)

**实现步骤** (如果不存在):
1. 选择缓存方案 (推荐 Redis)
2. 创建 `lib/cache.ts` 文件
3. 实现 `clearCache()` 函数
4. 在 SiteConfig 的 hooks 中调用缓存清理
5. 实现 Sitemap 重新生成逻辑
6. 测试缓存清理功能

**影响**:
- 如果未实现:
  - 配置修改后不生效，需要重启服务
  - 用户看到的是旧配置
- 如果已实现:
  - 配置修改立即生效
  - 提升运营效率

---

### 任务7: Media - 后台自定义缩略图视图

**优先级**: 🟢 低

**问题描述**:
- `docs/03-CMS后台功能.md` 中提到自定义缩略图视图
- 数据模型中有 `variants` 字段的自定义视图: `./custom-views/variants-display`
- **但这个自定义视图可能未实现**

**涉及文件**:
- `cms/schema/Media.ts` (数据模型)
- `cms/custom-views/variants-display.tsx` (自定义视图 - 可能不存在)

**需要检查**:
1. [ ] 确认 `cms/custom-views/variants-display.tsx` 文件是否存在
2. [ ] 确认后台媒体库是否显示缩略图预览
3. [ ] 确认是否可以查看所有变体 (thumbnail, small, medium, large, webp)

**实现步骤** (如果不存在):
1. 创建 `cms/custom-views/variants-display.tsx` 文件
2. 实现自定义视图组件，展示所有图片变体
3. 在 Media 模型中引用该视图
4. 测试后台显示效果

**影响**:
- 如果未实现:
  - 后台只能看到原始图片
  - 无法直观查看优化后的图片
- 如果已实现:
  - 后台可以预览所有变体
  - 方便运营人员管理图片

---

## 📊 优先级总结

### 🔴 高优先级 (必须完成) - ✅ 已完成
1. **✅ Media - 图片自动优化和多尺寸生成** - 直接影响性能和SEO - **已完成 (2025-11-05)**
2. **✅ SeoSetting - Sitemap/Robots.txt自动生成** - 直接影响SEO和搜索引擎收录 - **已完成 (2025-11-05)**
3. **✅ ContactForm - 邮件自动发送功能** - 直接影响客户体验和商机转化 - **已完成 (2025-11-05)**

### 🟡 中等优先级 (建议完成)
4. **NavigationMenu - 拖拽排序功能** - 影响运营效率
5. **CustomScript - 前端脚本注入逻辑** - 影响追踪代码和分析数据
6. **SiteConfig - 配置变更后的缓存清理** - 影响配置生效速度

### 🟢 低优先级 (可选)
7. **Media - 后台自定义缩略图视图** - 仅影响后台体验

---

## 🔍 检查清单

在开始实现之前，建议先运行以下检查:

### 1. 文件存在性检查
```bash
# 检查关键文件是否存在
ls -la lib/image-optimizer.ts
ls -la lib/email-sender.ts
ls -la lib/cache.ts
ls -la lib/api/custom-scripts.ts
ls -la app/sitemap.xml/route.ts
ls -la app/robots.txt/route.ts
ls -la admin/pages/navigation-manager.tsx
ls -la cms/custom-views/variants-display.tsx
```

### 2. 依赖检查
```bash
# 检查关键依赖是否已安装
npm list sharp
npm list nodemailer
npm list @aws-sdk/client-s3
npm list @dnd-kit/core
npm list @dnd-kit/sortable
```

### 3. 功能测试清单
- [ ] 上传一张图片，检查是否自动生成 variants
- [ ] 提交一个联系表单，检查是否收到邮件通知
- [ ] 访问 `/sitemap.xml`，检查是否正常生成
- [ ] 访问 `/robots.txt`，检查是否读取 SiteConfig
- [ ] 在后台配置一个追踪代码，检查前端是否加载
- [ ] 修改 SiteConfig，检查配置是否立即生效
- [ ] 在后台拖拽菜单排序，检查是否可以保存

---

## 📝 下一步

1. **运行检查清单**: 确认哪些功能已实现，哪些需要开发
2. **创建任务分支**: 为每个待完成的任务创建独立分支
3. **实现功能**: 按优先级依次实现
4. **测试验证**: 完成后进行功能测试
5. **更新文档**: 完成后更新本文档状态

---

## ✅ 高优先级任务完成总结

### 完成日期: 2025-11-05

### 已完成的功能:

#### 1. Media - 图片自动优化和多尺寸生成 ✅

**创建的文件:**
- `cms/lib/image-optimizer.ts` - 图片优化核心模块

**修改的文件:**
- `cms/schemas/Media.ts` - 添加了以下字段和功能:
  - `width` (integer) - 图片宽度(自动提取)
  - `height` (integer) - 图片高度(自动提取)
  - `fileSize` (integer) - 文件大小(自动提取)
  - `mimeType` (text) - MIME类型(自动提取)
  - `variants` (json) - 图片变体URL (thumbnail, small, medium, large, xlarge, webp)
  - hooks.afterOperation - 上传后自动生成优化图片

**功能说明:**
- 上传图片后自动提取元数据
- 自动生成5种尺寸变体 + WebP格式
- 所有变体上传到S3并返回CDN URL
- 错误处理完善,不会阻塞上传流程

#### 2. SeoSetting - Sitemap/Robots.txt自动生成 ✅

**创建的文件:**
- `web/lib/api/sitemap.ts` - Sitemap数据获取模块
- `web/app/sitemap.xml/route.ts` - Sitemap XML路由
- `web/app/robots.txt/route.ts` - Robots.txt路由

**功能说明:**
- `/sitemap.xml` - 动态生成包含所有页面的sitemap
  - 包含静态页面(首页、产品、服务等)
  - 自动获取动态路由(产品、博客、案例)
  - 设置正确的 lastmod、changefreq、priority
  - 支持多语言(24语言)
- `/robots.txt` - 动态生成robots.txt
  - 可通过CMS配置(SiteConfig.robotsTxtContent)
  - 默认配置可用
  - 自动包含sitemap链接
  - 缓存1小时提升性能

#### 3. ContactForm - 邮件自动发送功能 ✅

**创建的文件:**
- `cms/lib/email-sender.ts` - 邮件发送核心模块

**修改的文件:**
- `cms/schemas/ContactForm.ts` - 添加了以下字段和功能:
  - `emailSent` (checkbox) - 邮件发送状态标记
  - `relatedProduct` (relationship) - 关联产品(可选)
  - hooks.afterOperation - 提交后自动发送邮件

**功能说明:**
- 表单提交后自动发送邮件通知给管理员
  - 使用 SMTP 配置(从SiteConfig获取)
  - 美观的HTML邮件模板
  - 包含所有表单信息和提交详情
  - 支持多个通知邮箱
- 自动回复给客户(可配置)
  - 从SiteConfig读取模板
  - 支持变量替换({name}, {email}, {company})
- 错误处理完善,不会阻塞表单提交
- 更新emailSent标记方便追踪

### 技术亮点:

1. **错误处理**: 所有功能都有完善的错误处理,不会因为S3/SMTP配置问题导致核心功能失败
2. **性能优化**:
   - 图片变体并行生成
   - Sitemap/Robots.txt 缓存1小时
   - 使用CDN加速图片访问
3. **可配置性**:
   - 所有配置都从CMS读取,无需修改代码
   - 支持动态调整SMTP、追踪代码等
4. **SEO优化**:
   - 自动生成多尺寸图片和WebP格式
   - 完整的sitemap包含所有页面
   - Robots.txt指导搜索引擎爬取

### 下一步建议:

虽然高优先级任务已完成,但还有一些中等优先级的功能可以进一步提升系统:

**中等优先级 (建议实现):**
1. NavigationMenu - 拖拽排序功能
2. CustomScript - 前端脚本注入逻辑
3. SiteConfig - 配置变更后的缓存清理

**低优先级 (可选):**
4. Media - 后台自定义缩略图视图

### 测试清单:

**图片优化测试:**
- [ ] 上传一张图片到Media
- [ ] 检查是否自动提取了width、height、fileSize、mimeType
- [ ] 检查variants字段是否包含所有变体URL
- [ ] 访问变体URL确认图片已生成

**SEO测试:**
- [ ] 访问 `/sitemap.xml` 确认正常生成
- [ ] 检查sitemap是否包含所有产品、博客、案例
- [ ] 访问 `/robots.txt` 确认正常生成
- [ ] 确认sitemap链接在robots.txt中

**邮件测试:**
- [ ] 在SiteConfig中配置SMTP
- [ ] 提交一个测试表单
- [ ] 检查管理员是否收到通知邮件
- [ ] 检查客户是否收到自动回复(如启用)
- [ ] 检查emailSent字段是否更新为true

---

**文档维护**: 开发团队
**最后更新**: 2025-11-05
**高优先级任务完成日期**: 2025-11-05