# 01 æ•°æ®æ¨¡å‹ä¸æ¶æ„

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æŠ€æœ¯æ ˆ**: Keystone 6 + PostgreSQL + AWS S3/MinIO + Nginx
**æœ€åæ›´æ–°**: 2025-11-04

---

## æ–‡æ¡£å¯¼èˆª

- **å½“å‰æ–‡æ¡£**: 01-æ•°æ®æ¨¡å‹ä¸æ¶æ„
- [02-APIæ¥å£è§„èŒƒ](./02-APIæ¥å£è§„èŒƒ.md)
- [03-CMSåå°åŠŸèƒ½](./03-CMSåå°åŠŸèƒ½.md)
- [04-å®‰å…¨ä¸æ€§èƒ½](./04-å®‰å…¨ä¸æ€§èƒ½.md)
- [05-éƒ¨ç½²ä¸éªŒæ”¶](./05-éƒ¨ç½²ä¸éªŒæ”¶.md)

---

## ğŸ“‹ æŠ€æœ¯æ¶æ„ç¡®è®¤

### åç«¯æŠ€æœ¯æ ˆ
- **CMSæ¡†æ¶**: Keystone 6
- **æ•°æ®åº“**: PostgreSQL
- **å›¾ç‰‡/è§†é¢‘å­˜å‚¨**:
  - ç”Ÿäº§ç¯å¢ƒ:AWS S3 + CloudFront CDN
  - å¼€å‘ç¯å¢ƒ:MinIO (Docker) + Nginxåä»£
- **éƒ¨ç½²**: AWS EC2
- **è¯­è¨€**: Node.js + TypeScript

### å·²å®Œæˆçš„æ ¸å¿ƒæ•°æ®æ¨¡å‹
```
âœ… Media (åª’ä½“èµ„æº)
âœ… MediaCategory (åª’ä½“åˆ†ç±»)
âœ… MediaTag (åª’ä½“æ ‡ç­¾)
âœ… Category (åˆ†ç±»)
âœ… ProductSeries (äº§å“ç³»åˆ—)
âœ… Product (äº§å“)
âœ… Blog (åšå®¢)
âœ… Application (åº”ç”¨æ¡ˆä¾‹)
âœ… FaqItem (å¸¸è§é—®é¢˜)
âœ… ContactForm (è”ç³»è¡¨å•)
âœ… CustomScript (è‡ªå®šä¹‰ä»£ç )
âœ… SeoSetting (SEOè®¾ç½®)
âœ… SiteConfig (ç«™ç‚¹é…ç½®)
âœ… NavigationMenu (å¯¼èˆªèœå•)
âœ… HomeContent (é¦–é¡µå†…å®¹é…ç½® - 17ä¸ªåŒºå—ï¼Œ24è¯­è¨€)
âœ… Footer (é¡µè„šé…ç½® - Singletonï¼Œ24è¯­è¨€)
âœ… User (ç®¡ç†å‘˜ç”¨æˆ·)
âœ… Role (è§’è‰²æƒé™)
âœ… ActivityLog (æ“ä½œæ—¥å¿—)
```

### æ¨¡å‹è¯´æ˜
- **HomePage å·²åºŸå¼ƒ**: å·²è¢« HomeContent + Footer æ¨¡å‹æ›¿ä»£
- **HomeContent**: æ”¯æŒ17ä¸ªä¸åŒçš„å†…å®¹åŒºå—ï¼Œæ¯ä¸ªåŒºå—æ”¯æŒ24ç§è¯­è¨€
- **Footer**: ç‹¬ç«‹çš„å•ä¾‹æ¨¡å‹ï¼Œç®¡ç†é¡µè„šçš„è¡¨å•é…ç½®ã€è”ç³»ä¿¡æ¯ã€å®˜æ–¹å£°æ˜
- **å®Œæ•´APIæ–‡æ¡£**: [docs/api-contracts/HomeContentApiDocumentation.md](./api-contracts/HomeContentApiDocumentation.md)

---

## ğŸ“Š å®Œæ•´æ•°æ®æ¨¡å‹å®šä¹‰ (Keystone Schema)

### 1. ContactForm (è”ç³»è¡¨å•æäº¤)

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰ç”¨æˆ·é€šè¿‡å‰ç«¯è¡¨å•æäº¤çš„å’¨è¯¢/è¯¢ä»·æ•°æ®

**Keystone Schema**:
```typescript
import { list } from '@keystone-6/core';
import { text, timestamp, select, relationship, checkbox } from '@keystone-6/core/fields';

export const ContactForm = list({
  access: {
    operation: {
      query: ({ session }) => !!session, // ä»…ç™»å½•ç”¨æˆ·å¯æŸ¥çœ‹
      create: () => true, // å…¬å¼€æ¥å£å¯åˆ›å»º
      update: ({ session }) => !!session,
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    // åŸºç¡€ä¿¡æ¯
    name: text({
      validation: { isRequired: true },
      db: { isNullable: false },
      label: 'å§“å',
    }),

    email: text({
      validation: {
        isRequired: true,
        match: { regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, explanation: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' }
      },
      db: { isNullable: false },
      label: 'é‚®ç®±',
    }),

    whatsapp: text({
      label: 'WhatsApp',
    }),

    companyName: text({
      label: 'å…¬å¸åç§°',
    }),

    message: text({
      validation: { isRequired: true },
      db: { isNullable: false },
      ui: { displayMode: 'textarea' },
      label: 'ç•™è¨€å†…å®¹',
    }),

    // å…³è”äº§å“(ç”¨äºè¯¢ä»·)
    relatedProduct: relationship({
      ref: 'Product',
      label: 'å…³è”äº§å“',
      ui: {
        displayMode: 'select',
        labelField: 'name',
      }
    }),

    // å…ƒæ•°æ®
    submittedAt: timestamp({
      defaultValue: { kind: 'now' },
      label: 'æäº¤æ—¶é—´',
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' }
      }
    }),

    status: select({
      type: 'enum',
      options: [
        { label: 'æœªè¯»', value: 'unread' },
        { label: 'å·²è¯»', value: 'read' },
        { label: 'å·²å›å¤', value: 'replied' },
        { label: 'å·²å…³é—­', value: 'closed' },
      ],
      defaultValue: 'unread',
      label: 'å¤„ç†çŠ¶æ€',
      ui: { displayMode: 'segmented-control' }
    }),

    // æŠ€æœ¯å­—æ®µ
    ipAddress: text({
      label: 'IPåœ°å€',
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' }
      }
    }),

    userAgent: text({
      label: 'æµè§ˆå™¨ä¿¡æ¯',
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' }
      }
    }),

    // ç®¡ç†å‘˜å¤‡æ³¨
    adminNote: text({
      ui: { displayMode: 'textarea' },
      label: 'ç®¡ç†å‘˜å¤‡æ³¨',
    }),

    // é‚®ä»¶å‘é€çŠ¶æ€
    emailSent: checkbox({
      defaultValue: false,
      label: 'å·²å‘é€é‚®ä»¶é€šçŸ¥',
    }),
  },

  ui: {
    listView: {
      initialColumns: ['name', 'email', 'status', 'submittedAt'],
      initialSort: { field: 'submittedAt', direction: 'DESC' },
      pageSize: 50,
    },
    labelField: 'name',
  },

  hooks: {
    // åˆ›å»ºåå‘é€é‚®ä»¶é€šçŸ¥
    afterOperation: async ({ operation, item, context }) => {
      if (operation === 'create') {
        // TODO: è§¦å‘é‚®ä»¶å‘é€é€»è¾‘
        // await sendEmailNotification(item);
      }
    }
  }
});
```

**å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// POST /api/contact
const response = await fetch('/api/graphql', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: `
      mutation CreateContactForm($data: ContactFormCreateInput!) {
        createContactForm(data: $data) {
          id
          name
          email
          submittedAt
        }
      }
    `,
    variables: {
      data: {
        name: "å¼ ä¸‰",
        email: "zhang@example.com",
        whatsapp: "+86 138 0000 0000",
        companyName: "ABCå…¬å¸",
        message: "æˆ‘æƒ³äº†è§£Glass Standoffäº§å“çš„å®šåˆ¶æœåŠ¡",
        relatedProduct: { connect: { id: "product-id-123" } },
        ipAddress: req.ip,
        userAgent: req.headers['user-agent']
      }
    }
  })
});
```

---

### 2. CustomScript (è‡ªå®šä¹‰ä»£ç ç®¡ç†)

**ç”¨é€”**: å­˜å‚¨è¿è¥äººå‘˜é…ç½®çš„å…¨å±€/å•é¡µè¿½è¸ªä»£ç (Google Analyticsã€TikTok Pixelç­‰)

**Keystone Schema**:

```typescript
import { list } from '@keystone-6/core';
import {
  text,
  select,
  checkbox,
  timestamp,
  relationship,
  integer
} from '@keystone-6/core/fields';

export const CustomScript = list({
  access: {
    operation: {
      query: ({ session }) => !!session,
      create: ({ session }) => session?.data?.role === 'admin',
      update: ({ session }) => session?.data?.role === 'admin',
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    // ==================== åŸºç¡€ä¿¡æ¯ ====================
    name: text({
      validation: { isRequired: true },
      label: 'è„šæœ¬åç§°',
      db: { isNullable: false },
      ui: {
        description: 'å¦‚: Google Analytics, TikTok Pixel, Facebook Pixel'
      }
    }),

    description: text({
      ui: { displayMode: 'textarea' },
      label: 'æè¿°/å¤‡æ³¨',
    }),

    // ==================== è„šæœ¬å†…å®¹ ====================
    scriptPosition: select({
      type: 'enum',
      options: [
        { label: 'Header (å‰)', value: 'header' },
        { label: 'Footer (å‰)', value: 'footer' },
        { label: 'Bodyå¼€å§‹ (å)', value: 'body_start' },
      ],
      validation: { isRequired: true },
      defaultValue: 'header',
      label: 'æ³¨å…¥ä½ç½®',
    }),

    content: text({
      ui: { displayMode: 'textarea' },
      validation: { isRequired: true },
      label: 'è„šæœ¬å†…å®¹',
      db: { isNullable: false },
      ui: {
        description: 'è¯·è¾“å…¥å®Œæ•´çš„<script>æ ‡ç­¾æˆ–å…¶ä»–ä»£ç '
      }
    }),

    // ==================== åº”ç”¨èŒƒå›´(æ ¸å¿ƒä¼˜åŒ–éƒ¨åˆ†)====================

    scope: select({
      type: 'enum',
      options: [
        { label: 'å…¨å±€(æ‰€æœ‰é¡µé¢)', value: 'global' },
        { label: 'é¡µé¢ç±»å‹', value: 'page_type' },
        { label: 'ç²¾ç¡®è·¯å¾„', value: 'exact_path' },
        { label: 'è·¯å¾„è§„åˆ™(é€šé…ç¬¦)', value: 'path_pattern' },
        { label: 'å…³è”å†…å®¹', value: 'related_content' },
      ],
      validation: { isRequired: true },
      defaultValue: 'global',
      label: 'åº”ç”¨èŒƒå›´',
      ui: {
        displayMode: 'segmented-control',
        description: 'å†³å®šè„šæœ¬åœ¨å“ªäº›é¡µé¢åŠ è½½'
      }
    }),

    // ---------- é€‰é¡¹1: é¡µé¢ç±»å‹ ----------
    pageType: select({
      type: 'enum',
      options: [
        { label: 'é¦–é¡µ', value: 'home' },

        // äº§å“ç›¸å…³
        { label: 'äº§å“ç³»åˆ—åˆ—è¡¨é¡µ (/product)', value: 'product_series_list' },
        { label: 'äº§å“ç³»åˆ—è¯¦æƒ…é¡µ (/product/[series])', value: 'product_series_detail' },

        // å•†åº—ç›¸å…³
        { label: 'å•†åº—åˆ—è¡¨é¡µ (/shop)', value: 'shop_list' },
        { label: 'å•†åº—äº§å“è¯¦æƒ…é¡µ (/shop/[sku])', value: 'shop_detail' },

        // åšå®¢ç›¸å…³
        { label: 'åšå®¢åˆ—è¡¨é¡µ (/about-us/blog)', value: 'blog_list' },
        { label: 'åšå®¢è¯¦æƒ…é¡µ (/about-us/blog/[slug])', value: 'blog_detail' },

        // æ¡ˆä¾‹ç›¸å…³
        { label: 'æ¡ˆä¾‹åˆ—è¡¨é¡µ (/service/application)', value: 'application_list' },
        { label: 'æ¡ˆä¾‹è¯¦æƒ…é¡µ (/service/application/[id])', value: 'application_detail' },

        // æœåŠ¡ç›¸å…³
        { label: 'æœåŠ¡æ¦‚è§ˆé¡µ (/service)', value: 'service_overview' },
        { label: 'ä¸€ç«™å¼æœåŠ¡é¡µ (/service/one-stop-shop)', value: 'service_one_stop' },
        { label: 'FAQé¡µé¢ (/service/faq)', value: 'service_faq' },

        // å…³äºæˆ‘ä»¬ç›¸å…³
        { label: 'æˆ‘ä»¬çš„æ•…äº‹ (/about-us/story)', value: 'about_story' },
        { label: 'æ”¯æŒé¡µé¢ (/about-us/support)', value: 'about_support' },

        // å…¶ä»–
        { label: 'è”ç³»æˆ‘ä»¬é¡µé¢ (/contact-us)', value: 'contact' },
        { label: 'éšç§æ”¿ç­– (/privacy-policy)', value: 'privacy_policy' },
        { label: 'æ¬ºè¯ˆæé†’ (/fraud-notice)', value: 'fraud_notice' },
      ],
      label: 'é¡µé¢ç±»å‹',
      ui: {
        description: 'å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"é¡µé¢ç±»å‹"æ—¶ç”Ÿæ•ˆ'
      }
    }),

    // ---------- é€‰é¡¹2: ç²¾ç¡®è·¯å¾„ ----------
    exactPath: text({
      label: 'ç²¾ç¡®è·¯å¾„',
      ui: {
        description: 'å¦‚: /about-us/story, /service/faqã€‚å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"ç²¾ç¡®è·¯å¾„"æ—¶ç”Ÿæ•ˆ'
      }
    }),

    // ---------- é€‰é¡¹3: è·¯å¾„è§„åˆ™(é€šé…ç¬¦)----------
    pathPattern: text({
      label: 'è·¯å¾„è§„åˆ™(æ”¯æŒé€šé…ç¬¦)',
      ui: {
        description: 'å¦‚: /shop/*, /blog/*, /product/glass-*ã€‚å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"è·¯å¾„è§„åˆ™"æ—¶ç”Ÿæ•ˆ'
      }
    }),

    // ---------- é€‰é¡¹4: å…³è”å…·ä½“å†…å®¹ ----------
    relatedProduct: relationship({
      ref: 'Product',
      label: 'å…³è”äº§å“',
      ui: {
        displayMode: 'select',
        labelField: 'name',
        description: 'å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"å…³è”å†…å®¹"ä¸”ç›®æ ‡æ˜¯äº§å“æ—¶å¡«å†™'
      }
    }),

    relatedBlog: relationship({
      ref: 'Blog',
      label: 'å…³è”åšå®¢',
      ui: {
        displayMode: 'select',
        labelField: 'title',
        description: 'å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"å…³è”å†…å®¹"ä¸”ç›®æ ‡æ˜¯åšå®¢æ—¶å¡«å†™'
      }
    }),

    relatedApplication: relationship({
      ref: 'Application',
      label: 'å…³è”æ¡ˆä¾‹',
      ui: {
        displayMode: 'select',
        labelField: 'name',
        description: 'å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"å…³è”å†…å®¹"ä¸”ç›®æ ‡æ˜¯æ¡ˆä¾‹æ—¶å¡«å†™'
      }
    }),

    relatedProductSeries: relationship({
      ref: 'ProductSeries',
      label: 'å…³è”äº§å“ç³»åˆ—',
      ui: {
        displayMode: 'select',
        labelField: 'name',
        description: 'å½“"åº”ç”¨èŒƒå›´"é€‰æ‹©"å…³è”å†…å®¹"ä¸”ç›®æ ‡æ˜¯äº§å“ç³»åˆ—æ—¶å¡«å†™'
      }
    }),

    // ==================== é«˜çº§é€‰é¡¹ ====================

    enabled: checkbox({
      defaultValue: false,
      label: 'æ˜¯å¦å¯ç”¨',
      ui: {
        description: 'å…³é—­åä¸ä¼šåŠ è½½æ­¤è„šæœ¬'
      }
    }),

    priority: integer({
      defaultValue: 5,
      label: 'åŠ è½½ä¼˜å…ˆçº§',
      ui: {
        description: 'æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜(1-10),å½±å“è„šæœ¬åœ¨é¡µé¢ä¸­çš„åŠ è½½é¡ºåº'
      },
      validation: {
        min: 1,
        max: 10
      }
    }),

    async: checkbox({
      defaultValue: false,
      label: 'å¼‚æ­¥åŠ è½½(async)',
      ui: {
        description: 'é€‚ç”¨äºä¸éœ€è¦ç«‹å³æ‰§è¡Œçš„è„šæœ¬,æå‡é¡µé¢æ€§èƒ½'
      }
    }),

    defer: checkbox({
      defaultValue: false,
      label: 'å»¶è¿ŸåŠ è½½(defer)',
      ui: {
        description: 'è„šæœ¬åœ¨é¡µé¢è§£æå®Œæˆåæ‰§è¡Œ,é€‚ç”¨äºä¾èµ–DOMçš„è„šæœ¬'
      }
    }),

    // ==================== ç‰ˆæœ¬ç®¡ç† ====================

    version: text({
      defaultValue: '1.0',
      label: 'ç‰ˆæœ¬å·',
    }),

    changelog: text({
      ui: { displayMode: 'textarea' },
      label: 'æ›´æ–°æ—¥å¿—',
    }),

    // ==================== å…ƒæ•°æ® ====================

    createdAt: timestamp({
      defaultValue: { kind: 'now' },
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' }
      }
    }),

    updatedAt: timestamp({
      db: { updatedAt: true },
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' }
      }
    }),

    lastTestedAt: timestamp({
      label: 'æœ€åæµ‹è¯•æ—¶é—´',
      ui: {
        description: 'è®°å½•æœ€åä¸€æ¬¡éªŒè¯è„šæœ¬æ­£å¸¸å·¥ä½œçš„æ—¶é—´'
      }
    }),
  },

  // ==================== UIé…ç½® ====================

  ui: {
    listView: {
      initialColumns: ['name', 'scope', 'enabled', 'priority', 'updatedAt'],
      initialSort: { field: 'priority', direction: 'ASC' },
      pageSize: 50,
    },
    labelField: 'name',

    // å­—æ®µåˆ†ç»„
    itemView: {
      defaultFieldMode: 'edit',
      fieldGroups: [
        {
          label: 'åŸºç¡€ä¿¡æ¯',
          fields: ['name', 'description']
        },
        {
          label: 'è„šæœ¬å†…å®¹',
          fields: ['content', 'scriptPosition']
        },
        {
          label: 'åº”ç”¨èŒƒå›´',
          fields: [
            'scope',
            'pageType',
            'exactPath',
            'pathPattern',
            'relatedProduct',
            'relatedBlog',
            'relatedApplication',
            'relatedProductSeries'
          ],
          description: 'æ ¹æ®"åº”ç”¨èŒƒå›´"çš„é€‰æ‹©,å¡«å†™å¯¹åº”çš„å­—æ®µ'
        },
        {
          label: 'é«˜çº§é€‰é¡¹',
          fields: ['enabled', 'priority', 'async', 'defer']
        },
        {
          label: 'ç‰ˆæœ¬ä¿¡æ¯',
          fields: ['version', 'changelog', 'lastTestedAt']
        }
      ]
    }
  },

  // ==================== Hooks ====================

  hooks: {
    // ä¿å­˜å‰éªŒè¯
    validateInput: async ({ resolvedData, addValidationError, operation }) => {
      // 1. éªŒè¯è„šæœ¬å†…å®¹å®‰å…¨æ€§
      if (resolvedData.content) {
        const validation = validateScript(resolvedData.content);
        if (!validation.valid) {
          validation.errors.forEach(error => {
            addValidationError(error);
          });
        }
      }

      // 2. æ ¹æ®scopeéªŒè¯å¿…å¡«å­—æ®µ
      if (resolvedData.scope) {
        switch (resolvedData.scope) {
          case 'page_type':
            if (!resolvedData.pageType) {
              addValidationError('é€‰æ‹©"é¡µé¢ç±»å‹"èŒƒå›´æ—¶,å¿…é¡»æŒ‡å®šé¡µé¢ç±»å‹');
            }
            break;

          case 'exact_path':
            if (!resolvedData.exactPath) {
              addValidationError('é€‰æ‹©"ç²¾ç¡®è·¯å¾„"èŒƒå›´æ—¶,å¿…é¡»å¡«å†™è·¯å¾„');
            }
            break;

          case 'path_pattern':
            if (!resolvedData.pathPattern) {
              addValidationError('é€‰æ‹©"è·¯å¾„è§„åˆ™"èŒƒå›´æ—¶,å¿…é¡»å¡«å†™è§„åˆ™');
            }
            break;

          case 'related_content':
            const hasRelated = resolvedData.relatedProduct ||
                               resolvedData.relatedBlog ||
                               resolvedData.relatedApplication ||
                               resolvedData.relatedProductSeries;
            if (!hasRelated) {
              addValidationError('é€‰æ‹©"å…³è”å†…å®¹"èŒƒå›´æ—¶,å¿…é¡»å…³è”è‡³å°‘ä¸€ä¸ªå†…å®¹');
            }
            break;
        }
      }

      // 3. éªŒè¯asyncå’Œdeferä¸èƒ½åŒæ—¶å¯ç”¨
      if (resolvedData.async && resolvedData.defer) {
        addValidationError('asyncå’Œdeferä¸èƒ½åŒæ—¶å¯ç”¨');
      }
    },

    // åˆ›å»º/æ›´æ–°åæ¸…é™¤ç¼“å­˜
    afterOperation: async ({ operation, item }) => {
      if (['create', 'update', 'delete'].includes(operation)) {
        // æ¸…é™¤è„šæœ¬ç¼“å­˜
        await clearCache('custom-scripts-*');
      }
    }
  }
});

// ==================== è¾…åŠ©å‡½æ•° ====================

function validateScript(content: string): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  // å±é™©æ¨¡å¼æ£€æŸ¥
  const dangerousPatterns = [
    { pattern: /eval\(/g, message: 'âŒ ä¸å…è®¸ä½¿ç”¨ eval()' },
    { pattern: /<script[^>]*src=["'](?!https:\/\/)/gi, message: 'âŒ å¤–éƒ¨è„šæœ¬å¿…é¡»ä½¿ç”¨HTTPS' },
    { pattern: /document\.write/g, message: 'âŒ ä¸å…è®¸ä½¿ç”¨ document.write' },
    { pattern: /innerHTML\s*=/g, message: 'âš ï¸ æ…ç”¨ innerHTML,å»ºè®®ä½¿ç”¨ textContent' },
    { pattern: /onclick\s*=/gi, message: 'âŒ ä¸å…è®¸å†…è”äº‹ä»¶å¤„ç†å™¨(onclickç­‰)' },
    { pattern: /onerror\s*=/gi, message: 'âŒ ä¸å…è®¸å†…è”äº‹ä»¶å¤„ç†å™¨(onerrorç­‰)' },
  ];

  for (const { pattern, message } of dangerousPatterns) {
    if (pattern.test(content)) {
      errors.push(message);
    }
  }

  // ç™½åå•åŸŸåæ£€æŸ¥
  const allowedDomains = [
    'www.googletagmanager.com',
    'www.google-analytics.com',
    'connect.facebook.net',
    'analytics.tiktok.com',
    'cdn.jsdelivr.net',
    'unpkg.com',
  ];

  const scriptTagRegex = /<script[^>]*src=["'](https:\/\/[^"']+)["']/gi;
  let match;

  while ((match = scriptTagRegex.exec(content)) !== null) {
    try {
      const url = new URL(match[1]);
      if (!allowedDomains.some(domain => url.hostname.includes(domain))) {
        errors.push(`âš ï¸ åŸŸå ${url.hostname} ä¸åœ¨ç™½åå•ä¸­,è¯·ç¡®è®¤å®‰å…¨æ€§`);
      }
    } catch {
      errors.push('âŒ æ— æ•ˆçš„è„šæœ¬URL');
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}
```

**å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// GET /api/scripts/global
const response = await fetch('/api/graphql', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: `
      query GetGlobalScripts {
        customScripts(
          where: {
            enabled: { equals: true },
            type: { in: ["global_header", "global_footer"] }
          },
          orderBy: { priority: asc }
        ) {
          id
          type
          content
          priority
        }
      }
    `
  })
});
```

---

### 3. SeoSetting (SEOè®¾ç½®)

**ç”¨é€”**: å…¨å±€SEOé…ç½® + å•é¡µSEOè®¾ç½®

**Keystone Schema**:
```typescript
export const SeoSetting = list({
  access: {
    operation: {
      query: () => true, // å‰ç«¯éœ€è¦è¯»å–
      create: ({ session }) => session?.data?.role === 'admin',
      update: ({ session }) => session?.data?.role === 'admin',
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    // æ ‡è¯†(ç”¨äºåŒºåˆ†å…¨å±€æˆ–å•é¡µè®¾ç½®)
    identifier: text({
      validation: { isRequired: true },
      db: { isNullable: false, isUnique: true },
      label: 'æ ‡è¯†ç¬¦',
      ui: {
        description: 'å…¨å±€è®¾ç½®ä½¿ç”¨ "global",å•é¡µä½¿ç”¨é¡µé¢slugå¦‚ "home", "about-us"'
      }
    }),

    // åŸºç¡€SEOå­—æ®µ
    title: text({
      validation: {
        isRequired: true,
        length: { max: 60 }
      },
      label: 'SEOæ ‡é¢˜',
      ui: {
        description: 'å»ºè®®50-60ä¸ªå­—ç¬¦,ä¼šæ˜¾ç¤ºåœ¨æœç´¢ç»“æœå’Œæµè§ˆå™¨æ ‡ç­¾'
      }
    }),

    description: text({
      validation: {
        isRequired: true,
        length: { max: 160 }
      },
      ui: { displayMode: 'textarea' },
      label: 'SEOæè¿°',
      ui: {
        description: 'å»ºè®®120-160ä¸ªå­—ç¬¦,ä¼šæ˜¾ç¤ºåœ¨æœç´¢ç»“æœæ‘˜è¦'
      }
    }),

    keywords: text({
      label: 'SEOå…³é”®è¯',
      ui: {
        description: 'å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”,å¦‚: glass standoff, architectural hardware'
      }
    }),

    // Open Graph (ç¤¾äº¤åˆ†äº«)
    ogTitle: text({
      label: 'OGæ ‡é¢˜',
      ui: {
        description: 'ç¤¾äº¤åˆ†äº«æ ‡é¢˜,ä¸ºç©ºåˆ™ä½¿ç”¨SEOæ ‡é¢˜'
      }
    }),

    ogDescription: text({
      ui: { displayMode: 'textarea' },
      label: 'OGæè¿°',
    }),

    ogImage: relationship({
      ref: 'Media',
      label: 'OGåˆ†äº«å›¾ç‰‡',
      ui: {
        displayMode: 'cards',
        cardFields: ['url', 'altText'],
        inlineCreate: { fields: ['url', 'altText'] },
      }
    }),

    // ç»“æ„åŒ–æ•°æ®
    schemaType: select({
      type: 'string',
      options: [
        { label: 'Organization (ç»„ç»‡)', value: 'Organization' },
        { label: 'Product (äº§å“)', value: 'Product' },
        { label: 'Article (æ–‡ç« )', value: 'Article' },
        { label: 'WebPage (ç½‘é¡µ)', value: 'WebPage' },
        { label: 'FAQPage (FAQé¡µé¢)', value: 'FAQPage' },
      ],
      label: 'Schema.orgç±»å‹',
    }),

    schemaData: text({
      ui: { displayMode: 'textarea' },
      label: 'ç»“æ„åŒ–æ•°æ®(JSON-LD)',
      ui: {
        description: 'è‡ªå®šä¹‰JSON-LDæ ¼å¼çš„ç»“æ„åŒ–æ•°æ®'
      }
    }),

    // å¤šè¯­è¨€æ”¯æŒ(é¢„ç•™)
    hreflangLinks: json({
      label: 'Hreflangé“¾æ¥',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualJSONDocumentField',
        description: 'Hreflang link in all 24 languages with auto-translation'
      }
    }),

    // Robotsæ§åˆ¶
    robotsIndex: checkbox({
      defaultValue: true,
      label: 'å…è®¸æœç´¢å¼•æ“ç´¢å¼•',
    }),

    robotsFollow: checkbox({
      defaultValue: true,
      label: 'å…è®¸è·Ÿè¸ªé“¾æ¥',
    }),

    // è§„èŒƒé“¾æ¥
    canonicalUrl: text({
      label: 'è§„èŒƒURL',
      ui: {
        description: 'æŒ‡å®šé¡µé¢çš„è§„èŒƒç‰ˆæœ¬,ç”¨äºå»é‡'
      }
    }),

    updatedAt: timestamp({
      db: { updatedAt: true },
    }),
  },

  ui: {
    listView: {
      initialColumns: ['identifier', 'title', 'robotsIndex', 'updatedAt'],
    },
    labelField: 'identifier',
  },
});
```

**å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// app/product/[slug]/page.tsx
export async function generateMetadata({ params }) {
  const seoData = await fetch('/api/graphql', {
    method: 'POST',
    body: JSON.stringify({
      query: `
        query GetSeoSetting($identifier: String!) {
          seoSetting(where: { identifier: $identifier }) {
            title
            description
            keywords
            ogTitle
            ogDescription
            ogImage { url }
            schemaData
            canonicalUrl
          }
        }
      `,
      variables: { identifier: `product-${params.slug}` }
    })
  });

  return {
    title: seoData.title,
    description: seoData.description,
    keywords: seoData.keywords?.split(','),
    openGraph: {
      title: seoData.ogTitle || seoData.title,
      description: seoData.ogDescription || seoData.description,
      images: [seoData.ogImage?.url],
    },
    alternates: {
      canonical: seoData.canonicalUrl
    }
  };
}
```

---

### 4. SiteConfig (ç«™ç‚¹å…¨å±€é…ç½®)

**ç”¨é€”**: å­˜å‚¨ç½‘ç«™é€šç”¨è®¾ç½®(å…¬å¸ä¿¡æ¯ã€è”ç³»æ–¹å¼ã€LOGOã€APIå¯†é’¥ç­‰)

**Keystone Schema**:
```typescript
export const SiteConfig = list({
  access: {
    operation: {
      query: () => true, // å‰ç«¯éœ€è¦è¯»å–
      create: ({ session }) => session?.data?.role === 'admin',
      update: ({ session }) => session?.data?.role === 'admin',
      delete: () => false, // ç¦æ­¢åˆ é™¤
    }
  },

  // å•ä¾‹æ¨¡å¼:åªå…è®¸å­˜åœ¨ä¸€æ¡é…ç½®è®°å½•
  isSingleton: true,

  fields: {
    // å…¬å¸åŸºæœ¬ä¿¡æ¯
    siteName: text({
      validation: { isRequired: true },
      label: 'ç½‘ç«™åç§°',
      defaultValue: 'Busrom'
    }),

    companyName: text({
      validation: { isRequired: true },
      label: 'å…¬å¸å…¨ç§°',
      defaultValue: 'Busrom Hardware Co., Ltd.'
    }),

    logo: relationship({
      ref: 'Media',
      label: 'ç½‘ç«™LOGO',
    }),

    favicon: relationship({
      ref: 'Media',
      label: 'ç½‘ç«™å›¾æ ‡(Favicon)',
    }),

    // è”ç³»ä¿¡æ¯
    email: text({
      validation: {
        match: { regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ }
      },
      label: 'è”ç³»é‚®ç®±',
    }),

    phone: text({
      label: 'è”ç³»ç”µè¯',
    }),

    whatsapp: text({
      label: 'WhatsAppå·ç ',
    }),

    wechat: text({
      label: 'å¾®ä¿¡å·',
    }),

    address: text({
      ui: { displayMode: 'textarea' },
      label: 'å…¬å¸åœ°å€',
    }),

    // ç¤¾äº¤åª’ä½“é“¾æ¥
    facebookUrl: text({ label: 'Facebooké“¾æ¥' }),
    instagramUrl: text({ label: 'Instagramé“¾æ¥' }),
    linkedinUrl: text({ label: 'LinkedIné“¾æ¥' }),
    youtubeUrl: text({ label: 'YouTubeé“¾æ¥' }),
    twitterUrl: text({ label: 'Twitteré“¾æ¥' }),

    // ç¬¬ä¸‰æ–¹æœåŠ¡APIå¯†é’¥
    googleAnalyticsId: text({
      label: 'Google Analytics ID',
      ui: {
        description: 'å¦‚: G-XXXXXXXXXX'
      }
    }),

    googleSearchConsoleKey: text({
      label: 'Google Search ConsoleéªŒè¯ç ',
    }),

    tiktokPixelId: text({
      label: 'TikTok Pixel ID',
    }),

    // é‚®ä»¶æœåŠ¡é…ç½®
    smtpHost: text({ label: 'SMTPæœåŠ¡å™¨' }),
    smtpPort: text({ label: 'SMTPç«¯å£' }),
    smtpUser: text({ label: 'SMTPç”¨æˆ·å' }),
    smtpPassword: text({
      label: 'SMTPå¯†ç ',
      ui: { displayMode: 'password' }
    }),

    emailFromAddress: text({
      label: 'å‘ä»¶äººé‚®ç®±',
      defaultValue: 'noreply@busrom.com'
    }),

    emailFromName: text({
      label: 'å‘ä»¶äººåç§°',
      defaultValue: 'Busrom Team'
    }),

    // è¡¨å•é€šçŸ¥é…ç½®
    formNotificationEmails: text({
      label: 'è¡¨å•é€šçŸ¥é‚®ç®±',
      ui: {
        description: 'å¤šä¸ªé‚®ç®±ç”¨é€—å·åˆ†éš”'
      }
    }),

    enableAutoReply: checkbox({
      defaultValue: false,
      label: 'å¯ç”¨è¡¨å•è‡ªåŠ¨å›å¤',
    }),

    autoReplyTemplate: text({
      ui: { displayMode: 'textarea' },
      label: 'è‡ªåŠ¨å›å¤é‚®ä»¶æ¨¡æ¿',
      defaultValue: `Dear {name},

Thank you for contacting Busrom. We have received your message and will get back to you within 24 hours.

Best regards,
Busrom Team`
    }),

    // ç«™ç‚¹åŠŸèƒ½å¼€å…³
    maintenanceMode: checkbox({
      defaultValue: false,
      label: 'ç»´æŠ¤æ¨¡å¼',
      ui: {
        description: 'å¼€å¯åç½‘ç«™æ˜¾ç¤ºç»´æŠ¤é¡µé¢'
      }
    }),

    enableCaptcha: checkbox({
      defaultValue: true,
      label: 'å¯ç”¨éªŒè¯ç ',
    }),

    recaptchaSiteKey: text({
      label: 'reCAPTCHAç«™ç‚¹å¯†é’¥',
    }),

    recaptchaSecretKey: text({
      label: 'reCAPTCHAå¯†é’¥',
      ui: { displayMode: 'password' }
    }),

    // SEOé…ç½®
    defaultLanguage: select({
      type: 'string',
      options: [
        { label: 'English', value: 'en' },
        { label: 'ç®€ä½“ä¸­æ–‡', value: 'zh-CN' },
        { label: 'EspaÃ±ol', value: 'es' },
      ],
      defaultValue: 'en',
      label: 'é»˜è®¤è¯­è¨€',
    }),

    enableIndexNow: checkbox({
      defaultValue: true,
      label: 'å¯ç”¨IndexNowåè®®',
    }),

    indexNowKey: text({
      label: 'IndexNow APIå¯†é’¥',
    }),

    updatedAt: timestamp({
      db: { updatedAt: true },
    }),
  },

  ui: {
    labelField: 'siteName',
  },
});
```

**å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// è·å–ç«™ç‚¹é…ç½®(ç”¨äºHeader/Footer)
const siteConfig = await fetch('/api/graphql', {
  method: 'POST',
  body: JSON.stringify({
    query: `
      query GetSiteConfig {
        siteConfig {
          siteName
          companyName
          logo { url altText }
          email
          phone
          whatsapp
          facebookUrl
          linkedinUrl
          googleAnalyticsId
        }
      }
    `
  })
});
```

---

### 5. NavigationMenu (å¯¼èˆªèœå•ç®¡ç†)

**ç”¨é€”**: å¯è§†åŒ–é…ç½®ç½‘ç«™å¯¼èˆªèœå•ï¼Œæ”¯æŒå¤šçº§èœå•å’Œå¤šç§å±•ç¤ºç±»å‹

**å®é™…å¯¼èˆªç»“æ„**:
```
* Home
* Productï¼ˆäº§å“ç³»åˆ—ï¼‰
   * Glass Standoff
   * Glass Connected Fitting
   * Glass Fence Spigot
   * Glass Clip
   * Glass Hinge
   * Sliding Door Kit
   * Bathroom & Door Handle
   * Hidden Hook
* Shopï¼ˆäº§å“ï¼‰
   * [åŒä¸Šç³»åˆ—åˆ—è¡¨]
* Service
   * Service Overview
   * One-stop Shop
   * FAQ
   * Application
* About Us
   * Our Story
   * Blog
   * Support
   * Privacy Policy
   * Fraud Notice
* Contact Us
```

**Keystone Schema**:
```typescript
export const NavigationMenu = list({
  access: {
    operation: {
      query: () => true,
      create: ({ session }) => !!session,
      update: ({ session }) => !!session,
      delete: ({ session, item }) => {
        // ç³»ç»Ÿé»˜è®¤èœå•ä¸å¯åˆ é™¤
        if (item.isSystem) return false;
        return !!session;
      },
    }
  },

  fields: {
    // èœå•åç§°ï¼ˆå¤šè¯­è¨€ï¼‰
    name: json({
      validation: { isRequired: true },
      label: 'Menu Name (èœå•åç§°)',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualJSONField',
        description: 'å¯¼èˆªé¡¹æ˜¾ç¤ºåç§°',
      },
    }),

    // èœå•ç±»å‹
    type: select({
      type: 'enum',
      options: [
        { label: 'Standard (æ™®é€šé“¾æ¥)', value: 'STANDARD' },
        { label: 'Product Cards (å›¾æ–‡å¡ç‰‡)', value: 'PRODUCT_CARDS' },
        { label: 'Submenu (Icon+æ–‡å­—å­èœå•)', value: 'SUBMENU' },
      ],
      validation: { isRequired: true },
      defaultValue: 'STANDARD',
      label: 'Menu Type (èœå•ç±»å‹)',
      ui: {
        displayMode: 'segmented-control',
        description: 'å†³å®šå­èœå•çš„å±•ç¤ºå½¢å¼',
      },
    }),

    // å›¾æ ‡ï¼ˆç”¨äº SUBMENU ç±»å‹ï¼‰
    icon: text({
      label: 'Icon (å›¾æ ‡)',
      ui: {
        description: 'ä½¿ç”¨ Lucide-react å›¾æ ‡åç§°ï¼Œå¦‚: Home, Package, Wrenchã€‚ä»…åœ¨ type ä¸º SUBMENU æ—¶ä½¿ç”¨',
      },
    }),

    // å›¾ç‰‡ï¼ˆç”¨äº PRODUCT_CARDS ç±»å‹ï¼‰
    image: relationship({
      ref: 'Media',
      label: 'Card Image (å¡ç‰‡å›¾ç‰‡)',
      ui: {
        displayMode: 'cards',
        cardFields: ['filename'],
        description: 'ä»…åœ¨ type ä¸º PRODUCT_CARDS æ—¶ä½¿ç”¨ã€‚',
      },
    }),

    // çˆ¶çº§èœå•ï¼ˆå®ç°å¤šçº§èœå•ï¼‰
    parent: relationship({
      ref: 'NavigationMenu.children',
      label: 'Parent Menu (çˆ¶çº§èœå•)',
      ui: {
        displayMode: 'select',
        labelField: 'name',
        description: 'ç•™ç©ºè¡¨ç¤ºé¡¶çº§èœå•',
      },
    }),

    // å­èœå•
    children: relationship({
      ref: 'NavigationMenu.parent',
      many: true,
      label: 'Child Menus (å­èœå•)',
      ui: {
        displayMode: 'cards',
        cardFields: ['name', 'type', 'order'],
        inlineCreate: { fields: ['name', 'type', 'link', 'order'] },
        inlineEdit: { fields: ['name', 'type', 'link', 'order'] },
      },
    }),

    // é“¾æ¥åœ°å€
    link: text({
      label: 'Link (é“¾æ¥)',
      ui: {
        description: 'å¤–é“¾(https://...)æˆ–å†…éƒ¨è·¯å¾„(/product, /service)ã€‚é¡¶çº§èœå•å¯ç•™ç©º',
      },
    }),

    // æ’åº
    order: integer({
      defaultValue: 1,
      validation: {
        min: 1,
        max: 100,
      },
      label: 'Order (æ’åº)',
      ui: {
        description: 'æ•°å­—è¶Šå°è¶Šé å‰ã€‚CMS æ”¯æŒæ‹–æ‹½æ’åº',
      },
    }),

    // ç³»ç»Ÿèœå•æ ‡è¯†
    isSystem: checkbox({
      defaultValue: false,
      label: 'System Menu (ç³»ç»Ÿèœå•)',
      ui: {
        description: 'ç³»ç»Ÿé»˜è®¤èœå•ï¼Œä¸å¯åˆ é™¤',
        itemView: { fieldMode: 'read' },
      },
    }),

    // å¯è§æ€§
    visible: checkbox({
      defaultValue: true,
      label: 'Visible (æ˜¾ç¤º)',
      ui: {
        description: 'æ˜¯å¦åœ¨å¯¼èˆªæ ä¸­å±•ç¤º',
      },
    }),
  },

  ui: {
    listView: {
      initialColumns: ['name', 'type', 'parent', 'order', 'visible'],
      initialSort: { field: 'order', direction: 'ASC' },
      pageSize: 50,
    },
    labelField: 'name',
  },

  hooks: {
    // é˜»æ­¢åˆ é™¤ç³»ç»Ÿèœå•
    validateDelete: async ({ item, addValidationError }) => {
      if (item.isSystem) {
        addValidationError('Cannot delete system menu items | ç³»ç»Ÿèœå•é¡¹ä¸å¯åˆ é™¤');
      }
    },
  },
});
```

**å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// è·å–å®Œæ•´å¯¼èˆªæ ‘ç»“æ„
const { data } = await fetch('/api/graphql', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: `
      query GetNavigationMenu($locale: String!) {
        navigationMenus(
          where: {
            parent: { equals: null },
            visible: { equals: true }
          },
          orderBy: { order: asc }
        ) {
          id
          name
          type
          icon
          image {
            url
            alt
          }
          link
          children(
            where: { visible: { equals: true } },
            orderBy: { order: asc }
          ) {
            id
            name
            type
            icon
            image {
              url
              alt
            }
            link
          }
        }
      }
    `,
    variables: { locale: 'en' }
  })
});

// å‰ç«¯æ ¹æ® type æ¸²æŸ“ä¸åŒçš„å­èœå•æ ·å¼
const renderSubmenu = (menu) => {
  switch (menu.type) {
    case 'STANDARD':
      return <SimpleDropdown items={menu.children} />;
    
    case 'PRODUCT_CARDS':
      return (
        <MegaMenu>
          {menu.children.map(child => (
            <ProductCard
              key={child.id}
              image={child.image?.url}
              title={child.name}
              link={child.link}
            />
          ))}
        </MegaMenu>
      );
    
    case 'SUBMENU':
      return (
        <IconMenu>
          {menu.children.map(child => (
            <MenuItem
              key={child.id}
              icon={child.icon}
              label={child.name}
              link={child.link}
            />
          ))}
        </IconMenu>
      );
  }
};
```

**ä½¿ç”¨è¯´æ˜**:

1. **é¡¶çº§èœå•**: è®¾ç½® `parent` ä¸ºç©º
2. **å­èœå•**: é€‰æ‹©ç›¸åº”çš„ `parent`
3. **èœå•ç±»å‹**:
   - `STANDARD`: æ™®é€šä¸‹æ‹‰èœå•ï¼ˆå¦‚ Service çš„å­èœå•ï¼‰
   - `PRODUCT_CARDS`: å›¾æ–‡å¡ç‰‡å±•ç¤ºï¼ˆå¦‚ Product/Shop çš„äº§å“ç³»åˆ—ï¼‰
   - `SUBMENU`: å¸¦å›¾æ ‡çš„å­èœå•ï¼ˆå¦‚ About Us çš„å­èœå•ï¼‰
4. **ç³»ç»Ÿèœå•**: Homeã€Productã€Shop ç­‰æ ¸å¿ƒèœå•åº”æ ‡è®°ä¸º `isSystem: true`ï¼Œé˜²æ­¢è¯¯åˆ 

---

### 6. HomeContent (é¦–é¡µå†…å®¹é…ç½®)

**ç”¨é€”**: å­˜å‚¨é¦–é¡µå„ä¸ªåŠ¨æ€åŒºå—çš„é…ç½®æ•°æ®ï¼Œæ”¯æŒ17ä¸ªä¸åŒçš„å†…å®¹åŒºå—ï¼Œæ”¯æŒ24è¯­è¨€çš„å¤šè¯­è¨€å†…å®¹

**å®Œæ•´APIæ–‡æ¡£**: å‚è§ [docs/api-contracts/HomeContentApiDocumentation.md](../docs/api-contracts/HomeContentApiDocumentation.md)

**æ”¯æŒçš„åŒºå—ç±»å‹**:
1. **Hero Banner** - é¦–é¡µå¤§è½®æ’­ (9ä¸ªäº§å“ç³»åˆ—è½®æ’­ï¼Œæ¯ä¸ª4å¼ å›¾ç‰‡)
2. **Product Series Carousel** - äº§å“ç³»åˆ—è½®æ’­ (10ä¸ªäº§å“ç³»åˆ—)
3. **Service Features** - æœåŠ¡ç‰¹ç‚¹ (5ä¸ªç‰¹ç‚¹ï¼Œæ¯ä¸ªå¤šå¼ å›¾ç‰‡)
4. **3D Sphere** - 3Dçƒä½“å±•ç¤º (é¢„ç•™)
5. **Simple CTA** - ç®€æ˜“è¡ŒåŠ¨å·å¬ (3å¼ å›¾ç‰‡)
6. **Series Introduction** - ç³»åˆ—äº§å“ä»‹ç» (10ä¸ªç³»åˆ—)
7. **Featured Products** - ç²¾é€‰äº§å“ (10ä¸ªç³»åˆ—ï¼Œæ¯ä¸ª3ä¸ªäº§å“)
8. **Brand Advantages** - å“ç‰Œä¼˜åŠ¿ (9ä¸ªä¼˜åŠ¿ + å›¾æ ‡)
9. **OEM/ODM** - OEM/ODMæœåŠ¡ä»‹ç»
10. **Quote Steps** - è·å–æŠ¥ä»·äº”æ­¥æ›²
11. **Main Form** - ä¸»è¡¨å•é…ç½®
12. **Why Choose Busrom** - ä¸ºä»€ä¹ˆé€‰æ‹©Busrom (5ä¸ªåŸå› )
13. **Case Studies** - åº”ç”¨æ¡ˆä¾‹ (10ä¸ªæ¡ˆä¾‹)
14. **Brand Analysis** - å“ç‰Œåˆ†æ (Bus + romå«ä¹‰ + 3ä¸ªä¸­å¿ƒ)
15. **Brand Value** - å“ç‰Œä»·å€¼ä½“ç° (5ä¸ªä»·å€¼é¡¹)
16. **Footer** - é¡µè„šé…ç½® (ç‹¬ç«‹æ¨¡å‹ï¼Œè§ä¸‹æ–¹)
17. **Product Series List** - äº§å“ç³»åˆ—åˆ—è¡¨æ•°æ® (ä»ProductSeriesæ¨¡å‹è·å–)

**Keystone Schema**:
```typescript
import { list } from '@keystone-6/core'
import { text, select, checkbox, timestamp, integer, json } from '@keystone-6/core/fields'

export const HomeContent = list({
  access: {
    operation: {
      query: () => true, // å‰ç«¯éœ€è¦è¯»å–
      create: ({ session }) => !!session,
      update: ({ session }) => !!session,
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    // åŒºå—æ ‡è¯†
    section: select({
      type: 'string',
      options: [
        { label: 'Hero Banner | ä¸»è§†è§‰æ¨ªå¹…', value: 'hero_banner' },
        { label: 'Product Series Carousel | äº§å“ç³»åˆ—è½®æ’­', value: 'product_series_carousel' },
        { label: 'Service Features | æœåŠ¡ç‰¹ç‚¹', value: 'service_features' },
        { label: '3D Sphere | 3Dçƒä½“', value: 'sphere_3d' },
        { label: 'Simple CTA | ç®€å•CTA', value: 'simple_cta' },
        { label: 'Series Introduction | ç³»åˆ—ä»‹ç»', value: 'series_intro' },
        { label: 'Featured Products | ç²¾é€‰äº§å“', value: 'featured_products' },
        { label: 'Brand Advantages | å“ç‰Œä¼˜åŠ¿', value: 'brand_advantages' },
        { label: 'OEM/ODM | OEM/ODMæœåŠ¡', value: 'oem_odm' },
        { label: 'Quote Steps | è·å–æŠ¥ä»·äº”æ­¥æ›²', value: 'quote_steps' },
        { label: 'Main Form | ä¸»è¡¨å•é…ç½®', value: 'main_form' },
        { label: 'Why Choose Busrom | ä¸ºä»€ä¹ˆé€‰æ‹©Busrom', value: 'why_choose_busrom' },
        { label: 'Case Studies | åº”ç”¨æ¡ˆä¾‹', value: 'case_studies' },
        { label: 'Brand Analysis | å“ç‰Œåˆ†æ', value: 'brand_analysis' },
        { label: 'Brand Value | å“ç‰Œä»·å€¼', value: 'brand_value' },
      ],
      validation: { isRequired: true },
      isIndexed: 'unique',
      label: 'Section Type (åŒºå—ç±»å‹)',
    }),

    // å¯ç”¨çŠ¶æ€
    enabled: checkbox({
      defaultValue: true,
      label: 'Enabled (å¯ç”¨)',
      ui: {
        description: 'åœ¨é¦–é¡µæ˜¾ç¤º/éšè—æ­¤åŒºå—',
      },
    }),

    // æ’åº
    order: integer({
      defaultValue: 1,
      validation: { min: 1, max: 20 },
      label: 'Order (æ’åº)',
      ui: {
        description: 'æ˜¾ç¤ºé¡ºåº(æ•°å­—è¶Šå°è¶Šé å‰)',
      },
    }),

    // å¤šè¯­è¨€å†…å®¹ (JSONæ ¼å¼ï¼Œä½¿ç”¨è‡ªå®šä¹‰å­—æ®µç¼–è¾‘å™¨)
    content: json({
      label: 'Content (å¤šè¯­è¨€å†…å®¹)',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualHomeContentField',
        description: 'æ­¤åŒºå—çš„å¤šè¯­è¨€JSONå†…å®¹ï¼Œæ”¯æŒ24ç§è¯­è¨€',
      },
    }),

    updatedAt: timestamp({
      db: { updatedAt: true },
      label: 'Updated At (æ›´æ–°æ—¶é—´)',
    }),
  },

  ui: {
    listView: {
      initialColumns: ['section', 'enabled', 'order', 'updatedAt'],
      initialSort: { field: 'order', direction: 'ASC' },
      pageSize: 20,
    },
    labelField: 'section',
  },

  hooks: {
    validateInput: async ({ resolvedData, addValidationError }) => {
      // éªŒè¯ content å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON
      if (resolvedData.content) {
        try {
          if (typeof resolvedData.content === 'string') {
            JSON.parse(resolvedData.content)
          }
        } catch (error) {
          addValidationError('Content must be valid JSON format | å†…å®¹å¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼')
        }
      }
    },
  },
});
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**:

å®Œæ•´çš„æ•°æ®ç»“æ„ç¤ºä¾‹è¯·å‚è€ƒ API æ–‡æ¡£ï¼Œè¿™é‡Œå±•ç¤ºå‡ ä¸ªå…³é”®åŒºå—ï¼š

**Hero Banner** (9ä¸ªäº§å“ç³»åˆ—è½®æ’­):
```json
{
  "en": [
    {
      "title": "Glass Standoff",
      "features": [
        "Customized Minimalist Modern Glass Standoff",
        "Redefining Transparency & Modern Design",
        "Invisible Strength",
        "Adjustable Flexibility",
        "Superior Durability"
      ],
      "images": [
        { "url": "s3://bucket/1.jpg", "altText": "Glass Standoff main view" },
        { "url": "s3://bucket/2.svg", "altText": "Glass Standoff detail view" },
        { "url": "s3://bucket/3.jpg", "altText": "Glass Standoff installation" },
        { "url": "s3://bucket/4.jpg", "altText": "Glass Standoff in use" }
      ]
    }
    // ... å…¶ä»–8ä¸ªäº§å“ç³»åˆ—
  ],
  "zh": [
    // ä¸­æ–‡ç‰ˆæœ¬...
  ]
  // ... å…¶ä»–22ç§è¯­è¨€
}
```

**Service Features** (æœåŠ¡ç‰¹ç‚¹):
```json
{
  "en": {
    "title": "Premium Architectural Glass Hardware",
    "subtitle": "Fully Customized Glass Hardware by Busrom...",
    "features": [
      {
        "title": "Any Size, Any Structure, Any Shape",
        "shortTitle": "Any Size",
        "description": "Whether it's framed or frameless partitions...",
        "images": [
          { "url": "s3://bucket/1.jpg", "altText": "Custom size glass hardware" }
        ]
      }
      // ... å…¶ä»–4ä¸ªç‰¹ç‚¹
    ]
  },
  "zh": { /* ä¸­æ–‡ç‰ˆæœ¬ */ }
}
```

**Why Choose Busrom**:
```json
{
  "en": {
    "title": "Why Choose",
    "title2": "Busrom",
    "reasons": [
      {
        "title": "Original & Proprietary Design",
        "description": "Exclusive hardware that blends form and function.",
        "image": { "url": "s3://bucket/1.jpg", "altText": "Original proprietary design" }
      }
      // ... å…¶ä»–4ä¸ªåŸå› 
    ]
  }
}
```

**å‰ç«¯REST APIè°ƒç”¨ç¤ºä¾‹**:
```typescript
// è·å–å®Œæ•´é¦–é¡µå†…å®¹ (å•ä¸ªè¯­è¨€)
const response = await fetch('/api/home?locale=en')
const homeData = await response.json()

// è·å–ç‰¹å®šåŒºå—
const heroBanner = await fetch('/api/home/hero-banner?locale=en')
const productSeries = await fetch('/api/home/product-series?locale=en')
const serviceFeatures = await fetch('/api/home/service-features?locale=en')
const footer = await fetch('/api/home/footer?locale=en')

// å“åº”æ ¼å¼
{
  "locale": "en",
  "data": {
    // åŒºå—å†…å®¹
  }
}
```

**GraphQL APIè°ƒç”¨ç¤ºä¾‹** (ç”¨äº Next.js API è·¯ç”±å†…éƒ¨):
```typescript
const { data } = await fetch(process.env.GRAPHQL_ENDPOINT, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: `
      query GetHomeContent {
        homeContents(
          where: { enabled: { equals: true } },
          orderBy: { order: asc }
        ) {
          section
          content
          order
          enabled
        }
      }
    `
  })
})

// è½¬æ¢ä¸º REST API æ ¼å¼
const transformedData = transformHomeContent(data.homeContents, locale)
```

**æ³¨æ„äº‹é¡¹**:
1. æ‰€æœ‰å›¾ç‰‡è·¯å¾„å­˜å‚¨ä¸º S3 å®Œæ•´ URL
2. æ¯ä¸ªå›¾ç‰‡å¿…é¡»åŒ…å«å¯¹åº”è¯­è¨€çš„ altText (SEOä¼˜åŒ–)
3. Case Studies æ•°æ®ä» Application æ¨¡å‹è·å–
4. Product Series æ•°æ®ä» ProductSeries æ¨¡å‹è·å–
5. Footer ä½œä¸ºç‹¬ç«‹æ¨¡å‹ç®¡ç† (è§ä¸‹ä¸€èŠ‚)

---

### 7. Footer (é¡µè„šé…ç½®)

**ç”¨é€”**: ç®¡ç†ç½‘ç«™é¡µè„šçš„å…¨å±€é…ç½®ï¼ŒåŒ…æ‹¬è”ç³»è¡¨å•ã€è”ç³»ä¿¡æ¯ã€å®˜æ–¹å£°æ˜ç­‰

**Keystone Schema**:
```typescript
import { list } from '@keystone-6/core'
import { json, checkbox, timestamp } from '@keystone-6/core/fields'

export const Footer = list({
  access: {
    operation: {
      query: () => true, // å‰ç«¯éœ€è¦è¯»å–
      create: async ({ context }) => {
        const count = await context.query.Footer.count()
        return count === 0 // åªå…è®¸åˆ›å»ºä¸€æ¡è®°å½• (Singleton)
      },
      update: ({ session }) => !!session,
      delete: () => false, // ç¦æ­¢åˆ é™¤
    }
  },

  // å•ä¾‹æ¨¡å¼
  isSingleton: true,

  fields: {
    // è¡¨å•é…ç½® (å¤šè¯­è¨€)
    formConfig: json({
      label: 'Form Configuration (è¡¨å•é…ç½®)',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualJSONField',
        description: 'é¡µè„šè”ç³»è¡¨å•çš„é…ç½® (æ ‡é¢˜ã€å ä½ç¬¦ã€æŒ‰é’®æ–‡å­—)',
      },
    }),

    // è”ç³»ä¿¡æ¯ (å¤šè¯­è¨€)
    contactInfo: json({
      label: 'Contact Information (è”ç³»ä¿¡æ¯)',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualJSONField',
        description: 'å…¬å¸è”ç³»ä¿¡æ¯ (é‚®ç®±ã€ç”µè¯ã€WhatsApp)',
      },
    }),

    // å®˜æ–¹å£°æ˜ (å¤šè¯­è¨€)
    officialNotice: json({
      label: 'Official Notice (å®˜æ–¹å£°æ˜)',
      defaultValue: {},
      ui: {
        views: './custom-fields/MultilingualJSONField',
        description: 'å®˜æ–¹å£°æ˜å†…å®¹ (é˜²è¯ˆéª—æé†’ç­‰)',
      },
    }),

    // å¯ç”¨çŠ¶æ€
    enabled: checkbox({
      defaultValue: true,
      label: 'Enabled (å¯ç”¨)',
    }),

    updatedAt: timestamp({
      db: { updatedAt: true },
      label: 'Updated At (æ›´æ–°æ—¶é—´)',
      ui: {
        createView: { fieldMode: 'hidden' },
        itemView: { fieldMode: 'read' },
      },
    }),
  },

  ui: {
    listView: {
      initialColumns: ['enabled', 'updatedAt'],
    },
    labelField: 'enabled',
    // éšè—åˆ›å»ºæŒ‰é’® (Singleton)
    hideCreate: async ({ context }) => {
      const count = await context.query.Footer.count()
      return count >= 1
    },
  },

  hooks: {
    validateInput: async ({ resolvedData, addValidationError }) => {
      // éªŒè¯ JSON æ ¼å¼
      const jsonFields = ['formConfig', 'contactInfo', 'officialNotice']
      for (const field of jsonFields) {
        if (resolvedData[field]) {
          try {
            if (typeof resolvedData[field] === 'string') {
              JSON.parse(resolvedData[field])
            }
          } catch (error) {
            addValidationError(`${field} must be valid JSON format`)
          }
        }
      }
    },
  },
});
```

**æ•°æ®ç»“æ„ç¤ºä¾‹**:

```json
{
  "formConfig": {
    "en": {
      "title": "Contact Us",
      "placeholders": {
        "name": "Name",
        "email": "Email",
        "message": "Message"
      },
      "buttonText": "Submit"
    },
    "zh": {
      "title": "è”ç³»æˆ‘ä»¬",
      "placeholders": {
        "name": "å§“å",
        "email": "é‚®ç®±",
        "message": "ç•™è¨€"
      },
      "buttonText": "æäº¤"
    }
  },
  "contactInfo": {
    "en": {
      "title": "Busrom",
      "email": "info@busromhouse.com",
      "afterSales": "support@busromhouse.com",
      "whatsapp": "+86 13426931306"
    },
    "zh": {
      "title": "Busrom",
      "email": "info@busromhouse.com",
      "afterSales": "support@busromhouse.com",
      "whatsapp": "+86 13426931306"
    }
  },
  "officialNotice": {
    "en": {
      "title": "Official Notice",
      "lines": [
        "Official Email Contact: info@busromhouse.com.",
        "Any contact from non-official sources is unauthorized...",
        "For verification or any questions, contact us via...",
        "Busrom Team"
      ]
    },
    "zh": {
      "title": "å®˜æ–¹å£°æ˜",
      "lines": [
        "å®˜æ–¹é‚®ç®±è”ç³»æ–¹å¼: info@busromhouse.comã€‚",
        "ä»»ä½•éå®˜æ–¹æ¥æºçš„è”ç³»æ–¹å¼å‡æœªç»æˆæƒ...",
        "å¦‚éœ€éªŒè¯æˆ–æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·é€šè¿‡...",
        "Busrom å›¢é˜Ÿ"
      ]
    }
  }
}
```

**å‰ç«¯REST APIè°ƒç”¨**:
```typescript
// GET /api/home/footer?locale=en
const response = await fetch('/api/home/footer?locale=en')
const footerData = await response.json()

// å“åº”æ ¼å¼
{
  "locale": "en",
  "data": {
    "form": {
      "title": "Contact Us",
      "placeholders": {
        "name": "Name",
        "email": "Email",
        "message": "Message"
      },
      "buttonText": "Submit"
    },
    "contact": {
      "title": "Busrom",
      "email": "info@busromhouse.com",
      "afterSales": "support@busromhouse.com",
      "whatsapp": "+86 13426931306"
    },
    "notice": {
      "title": "Official Notice",
      "lines": [...]
    }
  }
}
```

---

### 8. User (ç®¡ç†å‘˜ç”¨æˆ·)

**Keystoneé»˜è®¤æä¾›,éœ€è‡ªå®šä¹‰å­—æ®µ**:
```typescript
export const User = list({
  access: {
    operation: {
      query: ({ session }) => !!session,
      create: ({ session }) => session?.data?.role === 'admin',
      update: ({ session, item }) =>
        session?.data?.id === item.id || session?.data?.role === 'admin',
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    name: text({
      validation: { isRequired: true },
      label: 'å§“å',
    }),

    email: text({
      validation: {
        isRequired: true,
        match: { regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ }
      },
      isIndexed: 'unique',
      label: 'é‚®ç®±',
    }),

    password: password({
      validation: { isRequired: true },
      label: 'å¯†ç ',
    }),

    role: select({
      type: 'string',
      options: [
        { label: 'è¶…çº§ç®¡ç†å‘˜', value: 'admin' },
        { label: 'å†…å®¹ç¼–è¾‘', value: 'editor' },
        { label: 'å†…å®¹å®¡æ ¸', value: 'reviewer' },
        { label: 'å®¢æœ', value: 'support' },
      ],
      defaultValue: 'editor',
      label: 'è§’è‰²',
    }),

    avatar: relationship({
      ref: 'Media',
      label: 'å¤´åƒ',
    }),

    twoFactorEnabled: checkbox({
      defaultValue: false,
      label: 'å¯ç”¨åŒå› ç´ è®¤è¯',
    }),

    lastLoginAt: timestamp({
      label: 'æœ€åç™»å½•æ—¶é—´',
    }),

    createdAt: timestamp({
      defaultValue: { kind: 'now' },
    }),
  },

  ui: {
    listView: {
      initialColumns: ['name', 'email', 'role', 'lastLoginAt'],
    },
    labelField: 'name',
  },
});
```

---

### 8. ActivityLog (æ“ä½œæ—¥å¿—)

**ç”¨é€”**: å®¡è®¡æ‰€æœ‰åå°æ“ä½œ,åŒ…æ‹¬å†…å®¹ä¿®æ”¹ã€åˆ é™¤ã€ç™»å½•ç­‰

**Keystone Schema**:
```typescript
export const ActivityLog = list({
  access: {
    operation: {
      query: ({ session }) => session?.data?.role === 'admin',
      create: () => true, // ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º
      update: () => false, // ç¦æ­¢ä¿®æ”¹
      delete: ({ session }) => session?.data?.role === 'admin',
    }
  },

  fields: {
    user: relationship({
      ref: 'User',
      label: 'æ“ä½œç”¨æˆ·',
    }),

    action: select({
      type: 'string',
      options: [
        { label: 'åˆ›å»º', value: 'create' },
        { label: 'æ›´æ–°', value: 'update' },
        { label: 'åˆ é™¤', value: 'delete' },
        { label: 'ç™»å½•', value: 'login' },
        { label: 'ç™»å‡º', value: 'logout' },
      ],
      validation: { isRequired: true },
      label: 'æ“ä½œç±»å‹',
    }),

    entity: text({
      label: 'å®ä½“ç±»å‹',
      ui: {
        description: 'å¦‚: Product, Blog, ContactForm'
      }
    }),

    entityId: text({
      label: 'å®ä½“ID',
    }),

    changes: text({
      ui: { displayMode: 'textarea' },
      label: 'ä¿®æ”¹å†…å®¹(JSON)',
    }),

    ipAddress: text({
      label: 'IPåœ°å€',
    }),

    userAgent: text({
      label: 'æµè§ˆå™¨ä¿¡æ¯',
    }),

    timestamp: timestamp({
      defaultValue: { kind: 'now' },
      label: 'æ“ä½œæ—¶é—´',
    }),
  },

  ui: {
    listView: {
      initialColumns: ['user', 'action', 'entity', 'timestamp'],
      initialSort: { field: 'timestamp', direction: 'DESC' },
      pageSize: 100,
    },
    labelField: 'action',
  },

  // ç¦æ­¢åœ¨UIä¸­åˆ›å»º
  ui: {
    createView: {
      defaultFieldMode: 'hidden',
    },
  },
});
```

---

## ä¸‹ä¸€æ­¥

ç°åœ¨æ•°æ®æ¨¡å‹å·²ç»å®šä¹‰å®Œæˆ,è¯·ç»§ç»­é˜…è¯»:
- [02-APIæ¥å£è§„èŒƒ](./02-APIæ¥å£è§„èŒƒ.md) - äº†è§£å¦‚ä½•ä½¿ç”¨GraphQL APIè®¿é—®è¿™äº›æ•°æ®

---

**æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ
**æœ€åå®¡æ ¸**: 2025-11-04
