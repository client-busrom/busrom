# 批量媒体上传功能

## 功能概述

批量媒体上传功能允许你通过可视化界面一次性上传多张图片，并支持：

1. **批量上传** - 拖拽或选择多张图片
2. **批量设置字段** - 同时给所有图片设置相同的字段值
3. **单独编辑** - 点击某张图片后，可以编辑该图片的特定字段
4. **实时预览** - 查看所有待上传图片的缩略图
5. **上传状态跟踪** - 实时显示每张图片的上传状态

## 使用方法

### 1. 访问批量上传页面

在 Keystone CMS 管理后台，导航到：

```
Media > 📤 Batch Upload
```

或直接访问：`http://localhost:3000/batch-upload`

### 2. 上传图片

有两种方式添加图片：

- **拖拽上传**：将图片文件拖拽到上传区域
- **选择文件**：点击上传区域，选择要上传的图片

支持一次性选择多张图片。

### 3. 批量设置字段

在 "🎯 批量设置字段" 区域，你可以设置以下字段：

- **替代文本 (中文)** - 图片的 alt 文本（用于 SEO）
- **主分类** - 选择图片的主分类
- **场景类型** - 选择单独/组合/系列
- **规格** - 输入规格，用逗号分隔（例如：50mm, 不锈钢）
- **颜色** - 输入颜色，用逗号分隔（例如：黑色, 银色）

设置完成后，点击 **"✅ 应用到所有图片"** 按钮，这些字段值会应用到所有待上传的图片。

### 4. 单独编辑图片

如果某张图片需要不同的字段值：

1. 点击图片缩略图，图片会高亮显示
2. 在 "✏️ 编辑图片" 区域，修改该图片的特定字段：
   - 替代文本 (中文)
   - 场景编号
   - 系列编号
   - 备注

修改会实时保存到该图片的元数据中。

### 5. 上传到媒体库

所有字段设置完成后：

1. 点击 **"🚀 上传所有图片"** 按钮
2. 系统会依次上传每张图片到 S3/MinIO
3. 每张图片的状态图标会实时更新：
   - ⏳ 上传中
   - ✓ 上传成功
   - ✗ 上传失败

4. 上传完成后，图片会自动添加到 Media 媒体库中

### 6. 管理上传列表

- **删除图片**：点击图片下方的 "删除" 按钮，从上传列表中移除
- **清空列表**：点击 "清空列表" 按钮，一次性移除所有图片

## 工作流程示例

### 场景 1: 批量上传产品图片

1. 拖拽 20 张产品图片到上传区域
2. 批量设置：
   - 替代文本：玻璃固定夹产品图
   - 主分类：产品图
   - 场景类型：单独
   - 规格：50mm, 不锈钢
3. 点击 "应用到所有图片"
4. 点击 "上传所有图片"

所有 20 张图片都会使用相同的字段值上传。

### 场景 2: 批量上传不同场景的图片

1. 拖拽 10 张场景图片到上传区域
2. 批量设置通用字段：
   - 主分类：场景图
   - 场景类型：单独
3. 点击 "应用到所有图片"
4. 逐个点击图片，为每张图片单独设置：
   - 场景编号：1, 2, 3...
   - 系列编号：根据实际情况
   - 备注：具体说明
5. 点击 "上传所有图片"

每张图片会保留自己独特的场景编号和备注。

## 字段说明

### 批量字段（应用到所有图片）

| 字段 | 说明 | 示例 |
|------|------|------|
| 替代文本 (中文) | 图片的 alt 属性，用于 SEO | 玻璃固定夹产品图 |
| 主分类 | 从 MediaCategory 选择 | 产品图、场景图等 |
| 场景类型 | 单独/组合/系列 | 单独 |
| 规格 | 用逗号分隔的规格列表 | 50mm, 不锈钢, 拉丝 |
| 颜色 | 用逗号分隔的颜色列表 | 黑色, 银色, 金色 |

### 单独编辑字段（针对某张图片）

| 字段 | 说明 | 示例 |
|------|------|------|
| 替代文本 (中文) | 覆盖批量设置的值 | 特定产品的 alt 文本 |
| 场景编号 | 场景序号 | 1, 2, 3... |
| 系列编号 | 系列序号 | 1, 2, 3... |
| 备注 | 其他说明信息 | 特殊拍摄角度 |

## 技术架构

### 前端组件

- **批量上传页面**：`cms/admin/pages/batch-media-upload.tsx`
- **自定义字段组件**：`cms/custom-fields/BatchMediaUpload.tsx`

### 上传方式

批量上传使用 **Keystone 原生的 GraphQL mutation** 和 **image field** 上传机制：

- **GraphQL Endpoint**：`POST /api/graphql`
- **Mutation**：`createMedia`
- **文件上传协议**：GraphQL multipart request (符合 [graphql-multipart-request-spec](https://github.com/jaydenseric/graphql-multipart-request-spec))

### 上传流程

1. 用户在前端选择文件
2. 前端通过 GraphQL multipart request 上传文件和元数据
3. Keystone 的 image field 自动处理文件上传到 S3/MinIO
4. Keystone 创建 Media 记录
5. Media hook 自动提取元数据和生成图片变体 (thumbnail, small, medium, large, xlarge, webp)

### 优势

使用 Keystone 原生上传方式的好处：

✅ **一致性**：批量上传与单张上传使用相同的机制
✅ **自动优化**：自动触发图片优化 hooks
✅ **类型安全**：通过 GraphQL schema 验证数据
✅ **简化维护**：无需维护自定义上传 API

## 注意事项

1. **文件大小限制**：单个文件最大 10MB
2. **文件类型限制**：仅支持图片文件（image/*）
3. **上传顺序**：图片会按顺序依次上传，不是并发上传
4. **错误处理**：如果某张图片上传失败，其他图片会继续上传
5. **网络要求**：需要稳定的网络连接，上传大量图片时请耐心等待

## 常见问题

### Q: 上传失败怎么办？

A: 检查以下几点：
1. 确认 S3/MinIO 服务正常运行
2. 检查 `.env` 文件中的 S3 配置
3. 查看浏览器控制台和服务器日志的错误信息
4. 确认图片文件未损坏且大小不超过 10MB

### Q: 可以修改已上传的图片吗？

A: 批量上传页面仅用于新图片的上传。要修改已上传的图片，请前往 `Media` 列表页面编辑。

### Q: 批量设置的字段可以在单独编辑时修改吗？

A: 可以！先批量设置通用字段，然后点击某张图片进行单独编辑，单独编辑的值会覆盖批量设置的值。

### Q: 支持哪些图片格式？

A: 支持所有常见图片格式：JPG, PNG, GIF, WebP, SVG 等（浏览器支持的所有 `image/*` 类型）。

## 开发与扩展

如果需要扩展批量上传功能，可以修改以下文件：

- **添加新字段**：修改 `batch-media-upload.tsx` 和 `ImageItem` 接口
- **修改上传逻辑**：修改 `upload-media.ts` 的上传处理逻辑
- **调整 UI 样式**：修改 `batch-media-upload.tsx` 的 CSS-in-JS 样式

## 相关文档

- [Media Schema 文档](../schemas/Media.ts)
- [Image Optimizer 文档](../lib/image-optimizer.ts)
- [S3 Storage 配置](../keystone.ts)
